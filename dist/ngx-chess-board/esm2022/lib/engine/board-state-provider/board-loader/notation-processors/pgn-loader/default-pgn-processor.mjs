import { Bishop } from '../../../../../models/pieces/bishop';
import { Color } from '../../../../../models/pieces/color';
import { King } from '../../../../../models/pieces/king';
import { Knight } from '../../../../../models/pieces/knight';
import { Pawn } from '../../../../../models/pieces/pawn';
import { Point } from '../../../../../models/pieces/point';
import { Queen } from '../../../../../models/pieces/queen';
import { Rook } from '../../../../../models/pieces/rook';
import { Coin } from '../../../../../models/pieces/coin';
import { MoveUtils } from '../../../../../utils/move-utils';
import { DefaultPiecesLoader } from '../../default-pieces-loader';
export class DefaultPgnProcessor {
    process(notation, engineFacade) {
        if (notation) {
            engineFacade.board.reverted = false;
            engineFacade.board.pieces = [];
            engineFacade.reset();
            DefaultPiecesLoader.loadDefaultPieces(engineFacade.board);
            let moves = this.extractMoves(notation);
            let counter = -1;
            for (let move of moves) {
                ++counter;
                move = move.replace(/[+#]/g, '');
                let promotionIndex = '';
                if (move.includes('=')) {
                    promotionIndex = this.resolvePromotion(move.substring(move.length - 1));
                    move = move.substring(0, move.length - 2);
                }
                let color = counter === 0 || counter % 2 === 0
                    ? Color.WHITE
                    : Color.BLACK;
                if (/^[a-z]\d$/g.test(move)) {
                    // zwykly ruch na wolne pole e4
                    let piece = MoveUtils.findPieceByPossibleMovesContaining(move, engineFacade.board, color).find((piece) => piece instanceof Pawn);
                    // en passant check
                    if (!piece) {
                        piece = MoveUtils.findPieceByPossibleCapturesContaining(move, engineFacade.board, color).find((piece) => piece instanceof Pawn);
                    }
                    // if piece is found for sure
                    if (piece) {
                        engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                            move +
                            promotionIndex);
                    }
                }
                else {
                    if (/^[A-Z][a-h]\d$/g.test(move)) {
                        // jezeli ma wielka litere, czyli trzeba odszukac ktora figura Nf3
                        let pieces = MoveUtils.findPieceByPossibleMovesContaining(move.substring(1), engineFacade.board, color);
                        let piece = pieces.find((piece) => this.resolvePieceByFirstChar(move.charAt(0), piece));
                        if (piece) {
                            engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                                move.substring(1) +
                                promotionIndex);
                        }
                        else {
                        }
                    }
                    else {
                        if ('O-O' === move) {
                            engineFacade.move(color === Color.WHITE ? 'e1g1' : 'e8g8');
                        }
                        else {
                            if (/^[a-z]x[a-z]\d$/g.test(move)) {
                                //exd5
                                let pieces = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).filter((piece) => piece instanceof Pawn);
                                let piece;
                                if (pieces.length > 1) {
                                    piece = this.resolveByCol(pieces, move.substring(0, 1));
                                }
                                else {
                                    piece = pieces[0];
                                }
                                if (piece) {
                                    engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                                        move.substring(move.indexOf('x') + 1) +
                                        promotionIndex);
                                }
                                else {
                                }
                            }
                            else {
                                if (/^[A-Z]x[a-z]\d$/g.test(move)) {
                                    let piece = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).find((piece) => this.resolvePieceByFirstChar(move.substring(0, 1), piece));
                                    if (piece) {
                                        engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                                            move.substring(move.indexOf('x') + 1) +
                                            promotionIndex);
                                    }
                                    else {
                                    }
                                }
                                else {
                                    if (move === 'O-O-O') {
                                        engineFacade.move(color === Color.WHITE
                                            ? 'e1c1'
                                            : 'e8c8');
                                    }
                                    else {
                                        if (/^[A-Z]\dx[a-z]\d$/g.test(move)) {
                                            //Ngxe4 sytuacja 2 skoczkow pion bicie
                                            let pieces = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).filter((piece) => this.resolvePieceByFirstChar(move.charAt(0), piece));
                                            let piece = this.resolveByRow(pieces, move.substring(1, 2));
                                            if (piece) {
                                                engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                                                    move.substring(move.indexOf('x') +
                                                        1) +
                                                    promotionIndex);
                                            }
                                        }
                                        else {
                                            if (/^[A-Z][a-z][a-z]\d$/g.test(move)) {
                                                // dwie wieze bez bicia Rac1 pion
                                                let pieces = MoveUtils.findPieceByPossibleMovesContaining(move.substring(2, 4), engineFacade.board, color).filter((piece) => this.resolvePieceByFirstChar(move.charAt(0), piece));
                                                let piece = this.resolveByCol(pieces, move.substring(1, 2));
                                                if (piece) {
                                                    engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                                                        move.substring(2, 4) +
                                                        promotionIndex);
                                                }
                                            }
                                            else {
                                                if (/^[A-Z][a-z]x[a-z]\d$/g.test(move)) {
                                                    let pieces = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).filter((piece) => this.resolvePieceByFirstChar(move.charAt(0), piece));
                                                    let piece = this.resolveByCol(pieces, move.substring(1, 2));
                                                    if (piece) {
                                                        engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                                                            move.substring(move.indexOf('x') + 1) +
                                                            promotionIndex);
                                                    }
                                                }
                                                else {
                                                    this.processR1f2(move, engineFacade, color, promotionIndex);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    processR1f2(move, engineFacade, color, promotionIndex) {
        if (/^[A-Z]\d[a-z]\d$/g.test(move)) {
            // R1f2
            let pieces = MoveUtils.findPieceByPossibleMovesContaining(move.substring(2, 4), engineFacade.board, color).filter((piece) => this.resolvePieceByFirstChar(move.charAt(0), piece));
            let piece = this.resolveByRow(pieces, move.substring(1, 2));
            if (piece) {
                engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                    move.substring(2, 4) +
                    promotionIndex);
            }
        }
    }
    extractMoves(notation) {
        return notation
            .substring(notation.lastIndexOf(']') + 1)
            .replace(/[0-9]+\./g, '')
            .replace(/\s+/g, ' ')
            .replace(/{[^}]*}/g, '')
            .trim()
            .split(' ')
            .filter((s) => s);
    }
    movePiece(piece, board, move) {
        let indexes = MoveUtils.translateCoordsToIndex(move, board.reverted);
        piece.point.col = indexes.xAxis;
        piece.point.row = indexes.yAxis;
    }
    hasUpperCase(move) {
        return /[A-Z]/.test(move);
    }
    resolvePieceByFirstChar(move, piece) {
        let piecesFirstChar = '';
        if (piece instanceof King) {
            piecesFirstChar = 'K';
        }
        else {
            if (piece instanceof Queen) {
                piecesFirstChar = 'Q';
            }
            else {
                if (piece instanceof Rook) {
                    piecesFirstChar = 'R';
                }
                else {
                    if (piece instanceof Bishop) {
                        piecesFirstChar = 'B';
                    }
                    else {
                        if (piece instanceof Knight) {
                            piecesFirstChar = 'N';
                        }
                        else {
                            if (piece instanceof Pawn) {
                                piecesFirstChar = 'P';
                            }
                            else {
                                if (piece instanceof Coin) {
                                    piecesFirstChar = 'C';
                                }
                            }
                        }
                    }
                }
            }
        }
        return move === piecesFirstChar;
    }
    isShortCastle(move) {
        return move === 'O-O';
    }
    removePiece(coords, board) {
        let indexes = MoveUtils.translateCoordsToIndex(coords, board.reverted);
        board.pieces = board.pieces.filter((e) => !e.point.isEqual(new Point(indexes.yAxis, indexes.xAxis)));
    }
    isLongCastle(move) {
        return move === 'O-O-O';
    }
    resolveByCol(pieces, char) {
        let firstPieceFormat = MoveUtils.formatSingle(pieces[0].point, false);
        let secondPieceFormat = MoveUtils.formatSingle(pieces[1].point, false);
        return firstPieceFormat.substring(0, 1) === char
            ? pieces[0]
            : pieces[1];
    }
    resolveByRow(pieces, char) {
        let firstPieceFormat = MoveUtils.formatSingle(pieces[0].point, false);
        let secondPieceFormat = MoveUtils.formatSingle(pieces[1].point, false);
        return firstPieceFormat.substring(1, 2) === char
            ? pieces[0]
            : pieces[1];
    }
    replacePromotion(move) {
        return move
            .replace('=Q', '1')
            .replace('=R', '2')
            .replace('=B', '3')
            .replace('=K', '4');
    }
    resolvePromotion(promotionChar) {
        switch (promotionChar) {
            case 'Q':
                return '1';
            case 'R':
                return '2';
            case 'B':
                return '3';
            case 'N':
                return '4';
        }
        return '';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1wZ24tcHJvY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWNoZXNzLWJvYXJkL3NyYy9saWIvZW5naW5lL2JvYXJkLXN0YXRlLXByb3ZpZGVyL2JvYXJkLWxvYWRlci9ub3RhdGlvbi1wcm9jZXNzb3JzL3Bnbi1sb2FkZXIvZGVmYXVsdC1wZ24tcHJvY2Vzc29yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3RCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDM0QsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ3pELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFFekQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQzNELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUMzRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDekQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ3pELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUU1RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUdsRSxNQUFNLE9BQU8sbUJBQW1CO0lBQ3JCLE9BQU8sQ0FBQyxRQUFnQixFQUFFLFlBQWtDO1FBQy9ELElBQUksUUFBUSxFQUFFLENBQUM7WUFDWCxZQUFZLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7WUFDcEMsWUFBWSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsRUFBRSxD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QUFFLEdBQUcsQ0FBQzthQUNsQixPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxhQUFxQjtRQUMxQyxRQUFRLGFBQWEsRUFBRSxDQUFDO1lBQ3BCLEtBQUssR0FBRztnQkFDSixPQUFPLEdBQUcsQ0FBQztZQUNmLEtBQUssR0FBRztnQkFDSixPQUFPLEdBQUcsQ0FBQztZQUNmLEtBQUssR0FBRztnQkFDSixPQUFPLEdBQUcsQ0FBQztZQUNmLEtBQUssR0FBRztnQkFDSixPQUFPLEdBQUcsQ0FBQztRQUNuQixDQUFDO1FBQ0QsT0FBTyxFQUFFLENBQUM7SUFDZCxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCb2FyZCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9ib2FyZCc7XG5pbXBvcnQgeyBCaXNob3AgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL2Jpc2hvcCc7XG5pbXBvcnQgeyBDb2xvciB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMvY29sb3InO1xuaW1wb3J0IHsgS2luZyB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMva2luZyc7XG5pbXBvcnQgeyBLbmlnaHQgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL2tuaWdodCc7XG5pbXBvcnQgeyBQYXduIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vbW9kZWxzL3BpZWNlcy9wYXduJztcbmltcG9ydCB7IFBpZWNlIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vbW9kZWxzL3BpZWNlcy9waWVjZSc7XG5pbXBvcnQgeyBQb2ludCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMvcG9pbnQnO1xuaW1wb3J0IHsgUXVlZW4gfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL3F1ZWVuJztcbmltcG9ydCB7IFJvb2sgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL3Jvb2snO1xuaW1wb3J0IHsgQ29pbiB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMvY29pbic7XG5pbXBvcnQgeyBNb3ZlVXRpbHMgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi91dGlscy9tb3ZlLXV0aWxzJztcbmltcG9ydCB7IEFic3RyYWN0RW5naW5lRmFjYWRlIH0gZnJvbSAnLi4vLi4vLi4vLi4vYWJzdHJhY3QtZW5naW5lLWZhY2FkZSc7XG5pbXBvcnQgeyBEZWZhdWx0UGllY2VzTG9hZGVyIH0gZnJvbSAnLi4vLi4vZGVmYXVsdC1waWVjZXMtbG9hZGVyJztcbmltcG9ydCB7IE5vdGF0aW9uUHJvY2Vzc29yIH0gZnJvbSAnLi4vbm90YXRpb24tcHJvY2Vzc29yJztcblxuZXhwb3J0IGNsYXNzIERlZmF1bHRQZ25Qcm9jZXNzb3IgaW1wbGVtZW50cyBOb3RhdGlvblByb2Nlc3NvciB7XG4gICAgcHVibGljIHByb2Nlc3Mobm90YXRpb246IHN0cmluZywgZW5naW5lRmFjYWRlOiBBYnN0cmFjdEVuZ2luZUZhY2FkZSk6IHZvaWQge1xuICAgICAgICBpZiAobm90YXRpb24pIHtcbiAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZC5yZXZlcnRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgZW5naW5lRmFjYWRlLmJvYXJkLnBpZWNlcyA9IFtdO1xuICAgICAgICAgICAgZW5naW5lRmFjYWRlLnJlc2V0KCk7XG4gICAgICAgICAgICBEZWZhdWx0UGllY2VzTG9hZGVyLmxvYWREZWZhdWx0UGllY2VzKGVuZ2luZUZhY2FkZS5ib2FyZCk7XG4gICAgICAgICAgICBsZXQgbW92ZXMgPSB0aGlzLmV4dHJhY3RNb3Zlcyhub3RhdGlvbik7XG4gICAgICAgICAgICBsZXQgY291bnRlciA9IC0xO1xuICAgICAgICAgICAgZm9yIChsZXQgbW92ZSBvZiBtb3Zlcykge1xuICAgICAgICAgICAgICAgICsrY291bnRlcjtcbiAgICAgICAgICAgICAgICBtb3ZlID0gbW92ZS5yZXBsYWNlKC9bKyNdL2csICcnKTtcbiAgICAgICAgICAgICAgICBsZXQgcHJvbW90aW9uSW5kZXggPSAnJztcblxuICAgICAgICAgICAgICAgIGlmIChtb3ZlLmluY2x1ZGVzKCc9JykpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvbW90aW9uSW5kZXggPSB0aGlzLnJlc29sdmVQcm9tb3Rpb24oXG4gICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZyhtb3ZlLmxlbmd0aCAtIDEpLFxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICBtb3ZlID0gbW92ZS5zdWJzdHJpbmcoMCwgbW92ZS5sZW5ndGggLSAyKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsZXQgY29sb3IgPVxuICAgICAgICAgICAgICAgICAgICBjb3VudGVyID09PSAwIHx8IGNvdW50ZXIgJSAyID09PSAwXG4gICAgICAgICAgICAgICAgICAgICAgICA/IENvbG9yLldISVRFXG4gICAgICAgICAgICAgICAgICAgICAgICA6IENvbG9yLkJMQUNLO1xuXG4gICAgICAgICAgICAgICAgaWYgKC9eW2Etel1cXGQkL2cudGVzdChtb3ZlKSkge1xuICAgICAgICAgICAgICAgICAgICAvLyB6d3lrbHkgcnVjaCBuYSB3b2xuZSBwb2xlIGU0XG4gICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZSA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlTW92ZXNDb250YWluaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgbW92ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yLFxuICAgICAgICAgICAgICAgICAgICApLmZpbmQoKHBpZWNlKSA9PiBwaWVjZSBpbnN0YW5jZW9mIFBhd24pO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIGVuIHBhc3NhbnQgY2hlY2tcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwaWVjZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UgPSBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZUNhcHR1cmVzQ29udGFpbmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcixcbiAgICAgICAgICAgICAgICAgICAgICAgICkuZmluZCgocGllY2UpID0+IHBpZWNlIGluc3RhbmNlb2YgUGF3bik7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBpZiBwaWVjZSBpcyBmb3VuZCBmb3Igc3VyZVxuICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5tb3ZlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUocGllY2UucG9pbnQsIGZhbHNlKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9tb3Rpb25JbmRleCxcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoL15bQS1aXVthLWhdXFxkJC9nLnRlc3QobW92ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGplemVsaSBtYSB3aWVsa2EgbGl0ZXJlLCBjenlsaSB0cnplYmEgb2RzenVrYWMga3RvcmEgZmlndXJhIE5mM1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlcyA9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVNb3Zlc0NvbnRhaW5pbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDEpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2UgPSBwaWVjZXMuZmluZCgocGllY2UpID0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNvbHZlUGllY2VCeUZpcnN0Q2hhcihtb3ZlLmNoYXJBdCgwKSwgcGllY2UpLFxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5tb3ZlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKHBpZWNlLnBvaW50LCBmYWxzZSkgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoMSkgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbW90aW9uSW5kZXgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoJ08tTycgPT09IG1vdmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPT09IENvbG9yLldISVRFID8gJ2UxZzEnIDogJ2U4ZzgnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgvXlthLXpdeFthLXpdXFxkJC9nLnRlc3QobW92ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9leGQ1XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZXMgPVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVDYXB0dXJlc0NvbnRhaW5pbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcobW92ZS5pbmRleE9mKCd4JykgKyAxKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLmZpbHRlcigocGllY2UpID0+IHBpZWNlIGluc3RhbmNlb2YgUGF3bik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2VzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlID0gdGhpcy5yZXNvbHZlQnlDb2woXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDAsIDEpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlID0gcGllY2VzWzBdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5pbmRleE9mKCd4JykgKyAxLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbW90aW9uSW5kZXgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC9eW0EtWl14W2Etel1cXGQkL2cudGVzdChtb3ZlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlID1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZUNhcHR1cmVzQ29udGFpbmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLmluZGV4T2YoJ3gnKSArIDEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKS5maW5kKChwaWVjZSkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNvbHZlUGllY2VCeUZpcnN0Q2hhcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDAsIDEpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5tb3ZlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLmluZGV4T2YoJ3gnKSArIDEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21vdGlvbkluZGV4LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vdmUgPT09ICdPLU8tTycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPT09IENvbG9yLldISVRFXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdlMWMxJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnZThjOCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC9eW0EtWl1cXGR4W2Etel1cXGQkL2cudGVzdChtb3ZlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL05neGU0IHN5dHVhY2phIDIgc2tvY3prb3cgcGlvbiBiaWNpZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2VzID1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlQ2FwdHVyZXNDb250YWluaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLmluZGV4T2YoJ3gnKSArIDEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLmZpbHRlcigocGllY2UpID0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNvbHZlUGllY2VCeUZpcnN0Q2hhcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5jaGFyQXQoMCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZSA9IHRoaXMucmVzb2x2ZUJ5Um93KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoMSwgMiksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5pbmRleE9mKCd4JykgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9tb3Rpb25JbmRleCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvXltBLVpdW2Etel1bYS16XVxcZCQvZy50ZXN0KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZHdpZSB3aWV6ZSBiZXogYmljaWEgUmFjMSBwaW9uXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2VzID1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZU1vdmVzQ29udGFpbmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoMiwgNCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKS5maWx0ZXIoKHBpZWNlKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc29sdmVQaWVjZUJ5Rmlyc3RDaGFyKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5jaGFyQXQoMCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2UgPSB0aGlzLnJlc29sdmVCeUNvbChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoMSwgMiksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9tb3Rpb25JbmRleCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC9eW0EtWl1bYS16XXhbYS16XVxcZCQvZy50ZXN0KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZXMgPVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZUNhcHR1cmVzQ29udGFpbmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuaW5kZXhPZihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3gnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgKyAxLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLmZpbHRlcigocGllY2UpID0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc29sdmVQaWVjZUJ5Rmlyc3RDaGFyKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuY2hhckF0KDApLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZSA9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVzb2x2ZUJ5Q29sKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5pbmRleE9mKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3gnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgMSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9tb3Rpb25JbmRleCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc1IxZjIoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21vdGlvbkluZGV4LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHByb2Nlc3NSMWYyKG1vdmUsIGVuZ2luZUZhY2FkZSwgY29sb3IsIHByb21vdGlvbkluZGV4KSB7XG4gICAgICAgIGlmICgvXltBLVpdXFxkW2Etel1cXGQkL2cudGVzdChtb3ZlKSkge1xuICAgICAgICAgICAgLy8gUjFmMlxuICAgICAgICAgICAgbGV0IHBpZWNlcyA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlTW92ZXNDb250YWluaW5nKFxuICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDIsIDQpLFxuICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcbiAgICAgICAgICAgICAgICBjb2xvcixcbiAgICAgICAgICAgICkuZmlsdGVyKChwaWVjZSkgPT5cbiAgICAgICAgICAgICAgICB0aGlzLnJlc29sdmVQaWVjZUJ5Rmlyc3RDaGFyKG1vdmUuY2hhckF0KDApLCBwaWVjZSksXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBsZXQgcGllY2UgPSB0aGlzLnJlc29sdmVCeVJvdyhwaWVjZXMsIG1vdmUuc3Vic3RyaW5nKDEsIDIpKTtcblxuICAgICAgICAgICAgaWYgKHBpZWNlKSB7XG4gICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLm1vdmUoXG4gICAgICAgICAgICAgICAgICAgIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUocGllY2UucG9pbnQsIGZhbHNlKSArXG4gICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygyLCA0KSArXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9tb3Rpb25JbmRleCxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGV4dHJhY3RNb3Zlcyhub3RhdGlvbjogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBub3RhdGlvblxuICAgICAgICAgICAgLnN1YnN0cmluZyhub3RhdGlvbi5sYXN0SW5kZXhPZignXScpICsgMSlcbiAgICAgICAgICAgIC5yZXBsYWNlKC9bMC05XStcXC4vZywgJycpXG4gICAgICAgICAgICAucmVwbGFjZSgvXFxzKy9nLCAnICcpXG4gICAgICAgICAgICAucmVwbGFjZSgve1tefV0qfS9nLCAnJylcbiAgICAgICAgICAgIC50cmltKClcbiAgICAgICAgICAgIC5zcGxpdCgnICcpXG4gICAgICAgICAgICAuZmlsdGVyKChzKSA9PiBzKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgbW92ZVBpZWNlKHBpZWNlOiBQaWVjZSwgYm9hcmQ6IEJvYXJkLCBtb3ZlOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IGluZGV4ZXMgPSBNb3ZlVXRpbHMudHJhbnNsYXRlQ29vcmRzVG9JbmRleChtb3ZlLCBib2FyZC5yZXZlcnRlZCk7XG4gICAgICAgIHBpZWNlLnBvaW50LmNvbCA9IGluZGV4ZXMueEF4aXM7XG4gICAgICAgIHBpZWNlLnBvaW50LnJvdyA9IGluZGV4ZXMueUF4aXM7XG4gICAgfVxuXG4gICAgaGFzVXBwZXJDYXNlKG1vdmU6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gL1tBLVpdLy50ZXN0KG1vdmUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVzb2x2ZVBpZWNlQnlGaXJzdENoYXIobW92ZTogc3RyaW5nLCBwaWVjZTogUGllY2UpIHtcbiAgICAgICAgbGV0IHBpZWNlc0ZpcnN0Q2hhciA9ICcnO1xuICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBLaW5nKSB7XG4gICAgICAgICAgICBwaWVjZXNGaXJzdENoYXIgPSAnSyc7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBRdWVlbikge1xuICAgICAgICAgICAgICAgIHBpZWNlc0ZpcnN0Q2hhciA9ICdRJztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgUm9vaykge1xuICAgICAgICAgICAgICAgICAgICBwaWVjZXNGaXJzdENoYXIgPSAnUic7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgQmlzaG9wKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwaWVjZXNGaXJzdENoYXIgPSAnQic7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBLbmlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZXNGaXJzdENoYXIgPSAnTic7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIFBhd24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzRmlyc3RDaGFyID0gJ1AnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIENvaW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlc0ZpcnN0Q2hhciA9ICdDJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbW92ZSA9PT0gcGllY2VzRmlyc3RDaGFyO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNTaG9ydENhc3RsZShtb3ZlOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIG1vdmUgPT09ICdPLU8nO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVtb3ZlUGllY2UoY29vcmRzOiBzdHJpbmcsIGJvYXJkOiBCb2FyZCkge1xuICAgICAgICBsZXQgaW5kZXhlcyA9IE1vdmVVdGlscy50cmFuc2xhdGVDb29yZHNUb0luZGV4KGNvb3JkcywgYm9hcmQucmV2ZXJ0ZWQpO1xuXG4gICAgICAgIGJvYXJkLnBpZWNlcyA9IGJvYXJkLnBpZWNlcy5maWx0ZXIoXG4gICAgICAgICAgICAoZSkgPT4gIWUucG9pbnQuaXNFcXVhbChuZXcgUG9pbnQoaW5kZXhlcy55QXhpcywgaW5kZXhlcy54QXhpcykpLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNMb25nQ2FzdGxlKG1vdmU6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gbW92ZSA9PT0gJ08tTy1PJztcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlc29sdmVCeUNvbChwaWVjZXM6IFBpZWNlW10sIGNoYXI6IHN0cmluZyk6IFBpZWNlIHtcbiAgICAgICAgbGV0IGZpcnN0UGllY2VGb3JtYXQgPSBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKHBpZWNlc1swXS5wb2ludCwgZmFsc2UpO1xuICAgICAgICBsZXQgc2Vjb25kUGllY2VGb3JtYXQgPSBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKHBpZWNlc1sxXS5wb2ludCwgZmFsc2UpO1xuICAgICAgICByZXR1cm4gZmlyc3RQaWVjZUZvcm1hdC5zdWJzdHJpbmcoMCwgMSkgPT09IGNoYXJcbiAgICAgICAgICAgID8gcGllY2VzWzBdXG4gICAgICAgICAgICA6IHBpZWNlc1sxXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlc29sdmVCeVJvdyhwaWVjZXM6IFBpZWNlW10sIGNoYXI6IHN0cmluZykge1xuICAgICAgICBsZXQgZmlyc3RQaWVjZUZvcm1hdCA9IE1vdmVVdGlscy5mb3JtYXRTaW5nbGUocGllY2VzWzBdLnBvaW50LCBmYWxzZSk7XG4gICAgICAgIGxldCBzZWNvbmRQaWVjZUZvcm1hdCA9IE1vdmVVdGlscy5mb3JtYXRTaW5nbGUocGllY2VzWzFdLnBvaW50LCBmYWxzZSk7XG4gICAgICAgIHJldHVybiBmaXJzdFBpZWNlRm9ybWF0LnN1YnN0cmluZygxLCAyKSA9PT0gY2hhclxuICAgICAgICAgICAgPyBwaWVjZXNbMF1cbiAgICAgICAgICAgIDogcGllY2VzWzFdO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVwbGFjZVByb21vdGlvbihtb3ZlOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIG1vdmVcbiAgICAgICAgICAgIC5yZXBsYWNlKCc9UScsICcxJylcbiAgICAgICAgICAgIC5yZXBsYWNlKCc9UicsICcyJylcbiAgICAgICAgICAgIC5yZXBsYWNlKCc9QicsICczJylcbiAgICAgICAgICAgIC5yZXBsYWNlKCc9SycsICc0Jyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZXNvbHZlUHJvbW90aW9uKHByb21vdGlvbkNoYXI6IHN0cmluZykge1xuICAgICAgICBzd2l0Y2ggKHByb21vdGlvbkNoYXIpIHtcbiAgICAgICAgICAgIGNhc2UgJ1EnOlxuICAgICAgICAgICAgICAgIHJldHVybiAnMSc7XG4gICAgICAgICAgICBjYXNlICdSJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gJzInO1xuICAgICAgICAgICAgY2FzZSAnQic6XG4gICAgICAgICAgICAgICAgcmV0dXJuICczJztcbiAgICAgICAgICAgIGNhc2UgJ04nOlxuICAgICAgICAgICAgICAgIHJldHVybiAnNCc7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICcnO1xuICAgIH1cbn1cbiJdfQ==