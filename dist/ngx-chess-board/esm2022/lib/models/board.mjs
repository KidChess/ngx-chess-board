import { cloneDeep } from 'lodash';
import { Bishop } from './pieces/bishop';
import { Coin } from './pieces/coin';
import { Color } from './pieces/color';
import { King } from './pieces/king';
import { Knight } from './pieces/knight';
import { Pawn } from './pieces/pawn';
import { Point } from './pieces/point';
import { Queen } from './pieces/queen';
import { Rook } from './pieces/rook';
export class Board {
    board = [];
    pieces = [];
    enPassantPoint = null;
    enPassantPiece = null;
    lastMoveSrc = null;
    lastMoveDest = null;
    activePiece;
    blackKingChecked;
    possibleCaptures = [];
    possibleMoves = [];
    whiteKingChecked;
    currentWhitePlayer = true;
    reverted = false;
    fullMoveCount = 1;
    fen;
    constructor() {
        for (let i = 0; i < 8; ++i) {
            this.board[i] = [];
            for (let j = 0; j < 8; ++j) {
                this.board[i][j] = 0;
            }
        }
    }
    isXYInPossibleMoves(row, col) {
        return this.possibleMoves.some((move) => move.row === row && move.col === col);
    }
    isXYInPossibleCaptures(row, col) {
        return this.possibleCaptures.some((capture) => capture.row === row && capture.col === col);
    }
    isXYInSourceMove(i, j) {
        return (this.lastMoveSrc &&
            this.lastMoveSrc.row === i &&
            this.lastMoveSrc.col === j);
    }
    isXYInDestMove(i, j) {
        return (this.lastMoveDest &&
            this.lastMoveDest.row === i &&
            this.lastMoveDest.col === j);
    }
    isXYInActiveMove(i, j) {
        return (this.activePiece &&
            this.activePiece.point.row === i &&
            this.activePiece.point.col === j);
    }
    isPointInPossibleMoves(point) {
        return this.possibleMoves.some((move) => move.row === point.row && move.col === point.col);
    }
    isPointInPossibleCaptures(point) {
        return this.possibleCaptures.some((capture) => capture.row === point.row && capture.col === point.col);
    }
    reset() {
        this.lastMoveDest = null;
        this.lastMoveSrc = null;
        this.whiteKingChecked = false;
        this.blackKingChecked = false;
        this.possibleCaptures = [];
        this.possibleMoves = [];
        this.activePiece = null;
        this.reverted = false;
        this.currentWhitePlayer = true;
        this.enPassantPoint = null;
        this.enPassantPiece = null;
        this.fullMoveCount = 1;
        this.calculateFEN();
    }
    reverse() {
        this.reverted = !this.reverted;
        this.activePiece = null;
        this.possibleMoves = [];
        this.possibleCaptures = [];
        this.pieces.forEach((piece) => this.reversePoint(piece.point));
        this.reversePoint(this.lastMoveSrc);
        this.reversePoint(this.lastMoveDest);
        if (this.enPassantPoint && this.enPassantPiece) {
            this.reversePoint(this.enPassantPoint);
        }
    }
    clone() {
        return cloneDeep(this);
    }
    isFieldTakenByEnemy(row, col, enemyColor) {
        if (row > 7 || row < 0 || col > 7 || col < 0) {
            return false;
        }
        return this.pieces.some((piece) => piece.point.col === col &&
            piece.point.row === row &&
            piece.color === enemyColor);
    }
    isFieldEmpty(row, col) {
        if (row > 7 || row < 0 || col > 7 || col < 0) {
            return false;
        }
        return !this.pieces.some((piece) => piece.point.col === col && piece.point.row === row);
    }
    isFieldUnderAttack(row, col, color) {
        return this.pieces
            .filter((piece) => piece.color === color)
            .some((piece) => piece
            .getCoveredFields()
            .some((field) => field.col === col && field.row === row));
    }
    getPieceByField(row, col) {
        if (this.isFieldEmpty(row, col)) {
            //   throw new Error('Piece not found');
            return undefined;
        }
        return this.pieces.find((piece) => piece.point.col === col && piece.point.row === row);
    }
    isKingInCheck(color, pieces) {
        const king = pieces.find((piece) => piece.color === color && piece instanceof King);
        if (king) {
            return pieces.some((piece) => piece
                .getPossibleCaptures()
                .some((point) => point.col === king.point.col &&
                point.row === king.point.row) && piece.color !== color);
        }
        return false;
    }
    getKingByColor(color) {
        return this.pieces.find((piece) => piece instanceof King && piece.color === color);
    }
    getCastleFENString(color) {
        const king = this.getKingByColor(color);
        if (!king || king.isMovedAlready) {
            return '';
        }
        let fen = '';
        const leftRook = this.getPieceByField(king.point.row, 0);
        const rightRook = this.getPieceByField(king.point.row, 7);
        if (rightRook instanceof Rook && rightRook.color === color) {
            if (!rightRook.isMovedAlready) {
                fen += this.reverted ? 'q' : 'k';
            }
        }
        if (leftRook instanceof Rook && leftRook.color === color) {
            if (!leftRook.isMovedAlready) {
                fen += this.reverted ? 'k' : 'q';
            }
        }
        fen = fen.split('').sort().join('');
        return color === Color.BLACK ? fen : fen.toUpperCase();
    }
    getEnPassantFENString() {
        if (this.enPassantPoint) {
            if (this.reverted) {
                return (String.fromCharCode(104 - this.enPassantPoint.col) +
                    (this.enPassantPoint.row + 1));
            }
            else {
                return (String.fromCharCode(97 + this.enPassantPoint.col) +
                    (Math.abs(this.enPassantPoint.row - 7) + 1));
            }
        }
        else {
            return '-';
        }
    }
    calculateFEN() {
        let fen = '';
        for (let i = 0; i < 8; ++i) {
            let emptyFields = 0;
            for (let j = 0; j < 8; ++j) {
                const foundPiece = this.pieces.find((piece) => piece.point.col === j && piece.point.row === i);
                if (foundPiece) {
                    if (emptyFields > 0) {
                        fen += emptyFields;
                        emptyFields = 0;
                    }
                    if (foundPiece instanceof Rook) {
                        fen += foundPiece.color === Color.BLACK ? 'r' : 'R';
                    }
                    else {
                        if (foundPiece instanceof Knight) {
                            fen += foundPiece.color === Color.BLACK ? 'n' : 'N';
                        }
                        else {
                            if (foundPiece instanceof Bishop) {
                                fen +=
                                    foundPiece.color === Color.BLACK
                                        ? 'b'
                                        : 'B';
                            }
                            else {
                                if (foundPiece instanceof Queen) {
                                    fen +=
                                        foundPiece.color === Color.BLACK
                                            ? 'q'
                                            : 'Q';
                                }
                                else {
                                    if (foundPiece instanceof King) {
                                        fen +=
                                            foundPiece.color === Color.BLACK
                                                ? 'k'
                                                : 'K';
                                    }
                                    else {
                                        if (foundPiece instanceof Pawn) {
                                            fen +=
                                                foundPiece.color === Color.BLACK
                                                    ? 'p'
                                                    : 'P';
                                        }
                                        else {
                                            if (foundPiece instanceof Coin) {
                                                fen +=
                                                    foundPiece.color ===
                                                        Color.BLACK
                                                        ? 'c'
                                                        : 'C';
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                else {
                    ++emptyFields;
                }
            }
            if (emptyFields > 0) {
                fen += emptyFields;
            }
            fen += '/';
        }
        fen = fen.substr(0, fen.length - 1);
        if (this.reverted) {
            fen = fen.split('').reverse().join('');
        }
        fen += ' ' + (this.currentWhitePlayer ? 'w' : 'b');
        const whiteEnPassant = this.getCastleFENString(Color.WHITE);
        const blackEnPassant = this.getCastleFENString(Color.BLACK);
        let concatedEnPassant = whiteEnPassant + blackEnPassant;
        if (!concatedEnPassant) {
            concatedEnPassant = '-';
        }
        fen += ' ' + concatedEnPassant;
        fen += ' ' + this.getEnPassantFENString();
        fen += ' ' + 0;
        fen += ' ' + this.fullMoveCount;
        this.fen = fen;
    }
    isXYInPointSelection(i, j) {
        return false;
    }
    reversePoint(point) {
        if (point) {
            point.row = Math.abs(point.row - 7);
            point.col = Math.abs(point.col - 7);
        }
    }
    getPieceByPoint(row, col) {
        row = Math.floor(row);
        col = Math.floor(col);
        return this.pieces.find((piece) => piece.point.col === col && piece.point.row === row);
    }
    checkIfPawnTakesEnPassant(newPoint) {
        if (newPoint.isEqual(this.enPassantPoint)) {
            this.pieces = this.pieces.filter((piece) => piece !== this.enPassantPiece);
            this.enPassantPoint = null;
            this.enPassantPiece = null;
        }
    }
    checkIfPawnEnpassanted(piece, newPoint) {
        if (Math.abs(piece.point.row - newPoint.row) > 1) {
            this.enPassantPiece = piece;
            this.enPassantPoint = new Point((piece.point.row + newPoint.row) / 2, piece.point.col);
        }
        else {
            this.enPassantPoint = null;
            this.enPassantPiece = null;
        }
    }
    isKingChecked(piece) {
        if (piece instanceof King) {
            return piece.color === Color.WHITE
                ? this.whiteKingChecked
                : this.blackKingChecked;
        }
    }
    getCurrentPlayerColor() {
        return this.currentWhitePlayer ? Color.WHITE : Color.BLACK;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9hcmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtY2hlc3MtYm9hcmQvc3JjL2xpYi9tb2RlbHMvYm9hcmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUNuQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVyQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFckMsTUFBTSxPQUFPLEtBQUs7SUFDZCxLQUFLLEdBQWUsRUFBRSxDQUFDO0lBQ3ZCLE1BQU0sR0FBWSxFQUFFLENBQUM7SUFFckIsY0FBYyxHQUFVLElBQUksQ0FBQztJQUM3QixjQUFjLEdBQVUsSUFBSSxDQUFDO0lBQzdCLFdBQVcsR0FBVSxJQUFJLENBQUM7SUFDMUIsWUFBWSxHQUFVLElBQUksQ0FBQztJQUMzQixXQUFXLENBQVE7SUFFbkIsZ0JBQWdCLENBQVU7SUFDMUIsZ0JBQWdCLEdBQVUsRUFBRSxDQUFDO0lBQzdCLGFBQWEsR0FBWSxFQUFFLENBQUM7SUFDNUIsZ0JBQWdCLENBQVU7SUFFMUIsa0JBQWtCLEdBQUcsSUFBSSxDQUFDO0lBQzFCLFFBQVEsR0FBRyxLQUFLLENB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QU0sQ0FBQztZQUNKLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO1lBQzNCLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO1FBQy9CLENBQUM7SUFDTCxDQUFDO0lBRUQsYUFBYSxDQUFDLEtBQVk7UUFDdEIsSUFBSSxLQUFLLFlBQVksSUFBSSxFQUFFLENBQUM7WUFDeEIsT0FBTyxLQUFLLENBQUMsS0FBSyxLQUFLLEtBQUssQ0FBQyxLQUFLO2dCQUM5QixDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQjtnQkFDdkIsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztRQUNoQyxDQUFDO0lBQ0wsQ0FBQztJQUVELHFCQUFxQjtRQUNqQixPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztJQUMvRCxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjbG9uZURlZXAgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgQmlzaG9wIH0gZnJvbSAnLi9waWVjZXMvYmlzaG9wJztcbmltcG9ydCB7IENvaW4gfSBmcm9tICcuL3BpZWNlcy9jb2luJztcbmltcG9ydCB7IENvbG9yIH0gZnJvbSAnLi9waWVjZXMvY29sb3InO1xuaW1wb3J0IHsgS2luZyB9IGZyb20gJy4vcGllY2VzL2tpbmcnO1xuaW1wb3J0IHsgS25pZ2h0IH0gZnJvbSAnLi9waWVjZXMva25pZ2h0JztcbmltcG9ydCB7IFBhd24gfSBmcm9tICcuL3BpZWNlcy9wYXduJztcbmltcG9ydCB7IFBpZWNlIH0gZnJvbSAnLi9waWVjZXMvcGllY2UnO1xuaW1wb3J0IHsgUG9pbnQgfSBmcm9tICcuL3BpZWNlcy9wb2ludCc7XG5pbXBvcnQgeyBRdWVlbiB9IGZyb20gJy4vcGllY2VzL3F1ZWVuJztcbmltcG9ydCB7IFJvb2sgfSBmcm9tICcuL3BpZWNlcy9yb29rJztcblxuZXhwb3J0IGNsYXNzIEJvYXJkIHtcbiAgICBib2FyZDogbnVtYmVyW11bXSA9IFtdO1xuICAgIHBpZWNlczogUGllY2VbXSA9IFtdO1xuXG4gICAgZW5QYXNzYW50UG9pbnQ6IFBvaW50ID0gbnVsbDtcbiAgICBlblBhc3NhbnRQaWVjZTogUGllY2UgPSBudWxsO1xuICAgIGxhc3RNb3ZlU3JjOiBQb2ludCA9IG51bGw7XG4gICAgbGFzdE1vdmVEZXN0OiBQb2ludCA9IG51bGw7XG4gICAgYWN0aXZlUGllY2U6IFBpZWNlO1xuXG4gICAgYmxhY2tLaW5nQ2hlY2tlZDogYm9vbGVhbjtcbiAgICBwb3NzaWJsZUNhcHR1cmVzOiBhbnlbXSA9IFtdO1xuICAgIHBvc3NpYmxlTW92ZXM6IFBvaW50W10gPSBbXTtcbiAgICB3aGl0ZUtpbmdDaGVja2VkOiBib29sZWFuO1xuXG4gICAgY3VycmVudFdoaXRlUGxheWVyID0gdHJ1ZTtcbiAgICByZXZlcnRlZCA9IGZhbHNlO1xuICAgIGZ1bGxNb3ZlQ291bnQgPSAxO1xuICAgIGZlbjogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgODsgKytpKSB7XG4gICAgICAgICAgICB0aGlzLmJvYXJkW2ldID0gW107XG4gICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IDg7ICsraikge1xuICAgICAgICAgICAgICAgIHRoaXMuYm9hcmRbaV1bal0gPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgaXNYWUluUG9zc2libGVNb3Zlcyhyb3c6IG51bWJlciwgY29sOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucG9zc2libGVNb3Zlcy5zb21lKFxuICAgICAgICAgICAgKG1vdmUpID0+IG1vdmUucm93ID09PSByb3cgJiYgbW92ZS5jb2wgPT09IGNvbCxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBpc1hZSW5Qb3NzaWJsZUNhcHR1cmVzKHJvdzogbnVtYmVyLCBjb2w6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wb3NzaWJsZUNhcHR1cmVzLnNvbWUoXG4gICAgICAgICAgICAoY2FwdHVyZSkgPT4gY2FwdHVyZS5yb3cgPT09IHJvdyAmJiBjYXB0dXJlLmNvbCA9PT0gY29sLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIGlzWFlJblNvdXJjZU1vdmUoaTogbnVtYmVyLCBqOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHRoaXMubGFzdE1vdmVTcmMgJiZcbiAgICAgICAgICAgIHRoaXMubGFzdE1vdmVTcmMucm93ID09PSBpICYmXG4gICAgICAgICAgICB0aGlzLmxhc3RNb3ZlU3JjLmNvbCA9PT0galxuICAgICAgICApO1xuICAgIH1cblxuICAgIGlzWFlJbkRlc3RNb3ZlKGk6IG51bWJlciwgajogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICB0aGlzLmxhc3RNb3ZlRGVzdCAmJlxuICAgICAgICAgICAgdGhpcy5sYXN0TW92ZURlc3Qucm93ID09PSBpICYmXG4gICAgICAgICAgICB0aGlzLmxhc3RNb3ZlRGVzdC5jb2wgPT09IGpcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBpc1hZSW5BY3RpdmVNb3ZlKGk6IG51bWJlciwgajogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICB0aGlzLmFjdGl2ZVBpZWNlICYmXG4gICAgICAgICAgICB0aGlzLmFjdGl2ZVBpZWNlLnBvaW50LnJvdyA9PT0gaSAmJlxuICAgICAgICAgICAgdGhpcy5hY3RpdmVQaWVjZS5wb2ludC5jb2wgPT09IGpcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBpc1BvaW50SW5Qb3NzaWJsZU1vdmVzKHBvaW50OiBQb2ludCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wb3NzaWJsZU1vdmVzLnNvbWUoXG4gICAgICAgICAgICAobW92ZSkgPT4gbW92ZS5yb3cgPT09IHBvaW50LnJvdyAmJiBtb3ZlLmNvbCA9PT0gcG9pbnQuY29sLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIGlzUG9pbnRJblBvc3NpYmxlQ2FwdHVyZXMocG9pbnQ6IFBvaW50KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLnBvc3NpYmxlQ2FwdHVyZXMuc29tZShcbiAgICAgICAgICAgIChjYXB0dXJlKSA9PiBjYXB0dXJlLnJvdyA9PT0gcG9pbnQucm93ICYmIGNhcHR1cmUuY29sID09PSBwb2ludC5jb2wsXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcmVzZXQoKSB7XG4gICAgICAgIHRoaXMubGFzdE1vdmVEZXN0ID0gbnVsbDtcbiAgICAgICAgdGhpcy5sYXN0TW92ZVNyYyA9IG51bGw7XG4gICAgICAgIHRoaXMud2hpdGVLaW5nQ2hlY2tlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmJsYWNrS2luZ0NoZWNrZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5wb3NzaWJsZUNhcHR1cmVzID0gW107XG4gICAgICAgIHRoaXMucG9zc2libGVNb3ZlcyA9IFtdO1xuICAgICAgICB0aGlzLmFjdGl2ZVBpZWNlID0gbnVsbDtcbiAgICAgICAgdGhpcy5yZXZlcnRlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmN1cnJlbnRXaGl0ZVBsYXllciA9IHRydWU7XG4gICAgICAgIHRoaXMuZW5QYXNzYW50UG9pbnQgPSBudWxsO1xuICAgICAgICB0aGlzLmVuUGFzc2FudFBpZWNlID0gbnVsbDtcbiAgICAgICAgdGhpcy5mdWxsTW92ZUNvdW50ID0gMTtcbiAgICAgICAgdGhpcy5jYWxjdWxhdGVGRU4oKTtcbiAgICB9XG5cbiAgICByZXZlcnNlKCkge1xuICAgICAgICB0aGlzLnJldmVydGVkID0gIXRoaXMucmV2ZXJ0ZWQ7XG4gICAgICAgIHRoaXMuYWN0aXZlUGllY2UgPSBudWxsO1xuICAgICAgICB0aGlzLnBvc3NpYmxlTW92ZXMgPSBbXTtcbiAgICAgICAgdGhpcy5wb3NzaWJsZUNhcHR1cmVzID0gW107XG5cbiAgICAgICAgdGhpcy5waWVjZXMuZm9yRWFjaCgocGllY2U6IFBpZWNlKSA9PiB0aGlzLnJldmVyc2VQb2ludChwaWVjZS5wb2ludCkpO1xuXG4gICAgICAgIHRoaXMucmV2ZXJzZVBvaW50KHRoaXMubGFzdE1vdmVTcmMpO1xuICAgICAgICB0aGlzLnJldmVyc2VQb2ludCh0aGlzLmxhc3RNb3ZlRGVzdCk7XG5cbiAgICAgICAgaWYgKHRoaXMuZW5QYXNzYW50UG9pbnQgJiYgdGhpcy5lblBhc3NhbnRQaWVjZSkge1xuICAgICAgICAgICAgdGhpcy5yZXZlcnNlUG9pbnQodGhpcy5lblBhc3NhbnRQb2ludCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjbG9uZSgpOiBCb2FyZCB7XG4gICAgICAgIHJldHVybiBjbG9uZURlZXAodGhpcyk7XG4gICAgfVxuXG4gICAgaXNGaWVsZFRha2VuQnlFbmVteShyb3c6IG51bWJlciwgY29sOiBudW1iZXIsIGVuZW15Q29sb3I6IENvbG9yKTogYm9vbGVhbiB7XG4gICAgICAgIGlmIChyb3cgPiA3IHx8IHJvdyA8IDAgfHwgY29sID4gNyB8fCBjb2wgPCAwKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMucGllY2VzLnNvbWUoXG4gICAgICAgICAgICAocGllY2UpID0+XG4gICAgICAgICAgICAgICAgcGllY2UucG9pbnQuY29sID09PSBjb2wgJiZcbiAgICAgICAgICAgICAgICBwaWVjZS5wb2ludC5yb3cgPT09IHJvdyAmJlxuICAgICAgICAgICAgICAgIHBpZWNlLmNvbG9yID09PSBlbmVteUNvbG9yLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIGlzRmllbGRFbXB0eShyb3c6IG51bWJlciwgY29sOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHJvdyA+IDcgfHwgcm93IDwgMCB8fCBjb2wgPiA3IHx8IGNvbCA8IDApIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gIXRoaXMucGllY2VzLnNvbWUoXG4gICAgICAgICAgICAocGllY2UpID0+IHBpZWNlLnBvaW50LmNvbCA9PT0gY29sICYmIHBpZWNlLnBvaW50LnJvdyA9PT0gcm93LFxuICAgICAgICApO1xuICAgIH1cblxuICAgIGlzRmllbGRVbmRlckF0dGFjayhyb3c6IG51bWJlciwgY29sOiBudW1iZXIsIGNvbG9yOiBDb2xvcikge1xuICAgICAgICByZXR1cm4gdGhpcy5waWVjZXNcbiAgICAgICAgICAgIC5maWx0ZXIoKHBpZWNlKSA9PiBwaWVjZS5jb2xvciA9PT0gY29sb3IpXG4gICAgICAgICAgICAuc29tZSgocGllY2UpID0+XG4gICAgICAgICAgICAgICAgcGllY2VcbiAgICAgICAgICAgICAgICAgICAgLmdldENvdmVyZWRGaWVsZHMoKVxuICAgICAgICAgICAgICAgICAgICAuc29tZSgoZmllbGQpID0+IGZpZWxkLmNvbCA9PT0gY29sICYmIGZpZWxkLnJvdyA9PT0gcm93KSxcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgZ2V0UGllY2VCeUZpZWxkKHJvdzogbnVtYmVyLCBjb2w6IG51bWJlcik6IFBpZWNlIHtcbiAgICAgICAgaWYgKHRoaXMuaXNGaWVsZEVtcHR5KHJvdywgY29sKSkge1xuICAgICAgICAgICAgLy8gICB0aHJvdyBuZXcgRXJyb3IoJ1BpZWNlIG5vdCBmb3VuZCcpO1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLnBpZWNlcy5maW5kKFxuICAgICAgICAgICAgKHBpZWNlKSA9PiBwaWVjZS5wb2ludC5jb2wgPT09IGNvbCAmJiBwaWVjZS5wb2ludC5yb3cgPT09IHJvdyxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBpc0tpbmdJbkNoZWNrKGNvbG9yOiBDb2xvciwgcGllY2VzOiBQaWVjZVtdKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGtpbmcgPSBwaWVjZXMuZmluZChcbiAgICAgICAgICAgIChwaWVjZSkgPT4gcGllY2UuY29sb3IgPT09IGNvbG9yICYmIHBpZWNlIGluc3RhbmNlb2YgS2luZyxcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoa2luZykge1xuICAgICAgICAgICAgcmV0dXJuIHBpZWNlcy5zb21lKFxuICAgICAgICAgICAgICAgIChwaWVjZSkgPT5cbiAgICAgICAgICAgICAgICAgICAgcGllY2VcbiAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRQb3NzaWJsZUNhcHR1cmVzKClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zb21lKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIChwb2ludCkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnQuY29sID09PSBraW5nLnBvaW50LmNvbCAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb2ludC5yb3cgPT09IGtpbmcucG9pbnQucm93LFxuICAgICAgICAgICAgICAgICAgICAgICAgKSAmJiBwaWVjZS5jb2xvciAhPT0gY29sb3IsXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBnZXRLaW5nQnlDb2xvcihjb2xvcjogQ29sb3IpOiBLaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGllY2VzLmZpbmQoXG4gICAgICAgICAgICAocGllY2UpID0+IHBpZWNlIGluc3RhbmNlb2YgS2luZyAmJiBwaWVjZS5jb2xvciA9PT0gY29sb3IsXG4gICAgICAgICkgYXMgS2luZztcbiAgICB9XG5cbiAgICBnZXRDYXN0bGVGRU5TdHJpbmcoY29sb3I6IENvbG9yKSB7XG4gICAgICAgIGNvbnN0IGtpbmcgPSB0aGlzLmdldEtpbmdCeUNvbG9yKGNvbG9yKTtcblxuICAgICAgICBpZiAoIWtpbmcgfHwga2luZy5pc01vdmVkQWxyZWFkeSkge1xuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGZlbiA9ICcnO1xuICAgICAgICBjb25zdCBsZWZ0Um9vayA9IHRoaXMuZ2V0UGllY2VCeUZpZWxkKGtpbmcucG9pbnQucm93LCAwKTtcbiAgICAgICAgY29uc3QgcmlnaHRSb29rID0gdGhpcy5nZXRQaWVjZUJ5RmllbGQoa2luZy5wb2ludC5yb3csIDcpO1xuXG4gICAgICAgIGlmIChyaWdodFJvb2sgaW5zdGFuY2VvZiBSb29rICYmIHJpZ2h0Um9vay5jb2xvciA9PT0gY29sb3IpIHtcbiAgICAgICAgICAgIGlmICghcmlnaHRSb29rLmlzTW92ZWRBbHJlYWR5KSB7XG4gICAgICAgICAgICAgICAgZmVuICs9IHRoaXMucmV2ZXJ0ZWQgPyAncScgOiAnayc7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobGVmdFJvb2sgaW5zdGFuY2VvZiBSb29rICYmIGxlZnRSb29rLmNvbG9yID09PSBjb2xvcikge1xuICAgICAgICAgICAgaWYgKCFsZWZ0Um9vay5pc01vdmVkQWxyZWFkeSkge1xuICAgICAgICAgICAgICAgIGZlbiArPSB0aGlzLnJldmVydGVkID8gJ2snIDogJ3EnO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgZmVuID0gZmVuLnNwbGl0KCcnKS5zb3J0KCkuam9pbignJyk7XG4gICAgICAgIHJldHVybiBjb2xvciA9PT0gQ29sb3IuQkxBQ0sgPyBmZW4gOiBmZW4udG9VcHBlckNhc2UoKTtcbiAgICB9XG5cbiAgICBnZXRFblBhc3NhbnRGRU5TdHJpbmcoKSB7XG4gICAgICAgIGlmICh0aGlzLmVuUGFzc2FudFBvaW50KSB7XG4gICAgICAgICAgICBpZiAodGhpcy5yZXZlcnRlZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoMTA0IC0gdGhpcy5lblBhc3NhbnRQb2ludC5jb2wpICtcbiAgICAgICAgICAgICAgICAgICAgKHRoaXMuZW5QYXNzYW50UG9pbnQucm93ICsgMSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgICAgICBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3ICsgdGhpcy5lblBhc3NhbnRQb2ludC5jb2wpICtcbiAgICAgICAgICAgICAgICAgICAgKE1hdGguYWJzKHRoaXMuZW5QYXNzYW50UG9pbnQucm93IC0gNykgKyAxKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gJy0nO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY2FsY3VsYXRlRkVOKCkge1xuICAgICAgICBsZXQgZmVuID0gJyc7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgODsgKytpKSB7XG4gICAgICAgICAgICBsZXQgZW1wdHlGaWVsZHMgPSAwO1xuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCA4OyArK2opIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmb3VuZFBpZWNlID0gdGhpcy5waWVjZXMuZmluZChcbiAgICAgICAgICAgICAgICAgICAgKHBpZWNlKSA9PiBwaWVjZS5wb2ludC5jb2wgPT09IGogJiYgcGllY2UucG9pbnQucm93ID09PSBpLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgaWYgKGZvdW5kUGllY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVtcHR5RmllbGRzID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmVuICs9IGVtcHR5RmllbGRzO1xuICAgICAgICAgICAgICAgICAgICAgICAgZW1wdHlGaWVsZHMgPSAwO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvdW5kUGllY2UgaW5zdGFuY2VvZiBSb29rKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmZW4gKz0gZm91bmRQaWVjZS5jb2xvciA9PT0gQ29sb3IuQkxBQ0sgPyAncicgOiAnUic7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm91bmRQaWVjZSBpbnN0YW5jZW9mIEtuaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlbiArPSBmb3VuZFBpZWNlLmNvbG9yID09PSBDb2xvci5CTEFDSyA/ICduJyA6ICdOJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvdW5kUGllY2UgaW5zdGFuY2VvZiBCaXNob3ApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVuICs9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VuZFBpZWNlLmNvbG9yID09PSBDb2xvci5CTEFDS1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ2InXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnQic7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvdW5kUGllY2UgaW5zdGFuY2VvZiBRdWVlbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVuICs9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRQaWVjZS5jb2xvciA9PT0gQ29sb3IuQkxBQ0tcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAncSdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnUSc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm91bmRQaWVjZSBpbnN0YW5jZW9mIEtpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZW4gKz1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRQaWVjZS5jb2xvciA9PT0gQ29sb3IuQkxBQ0tcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ2snXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdLJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvdW5kUGllY2UgaW5zdGFuY2VvZiBQYXduKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlbiArPVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRQaWVjZS5jb2xvciA9PT0gQ29sb3IuQkxBQ0tcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdwJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJ1AnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3VuZFBpZWNlIGluc3RhbmNlb2YgQ29pbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVuICs9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRQaWVjZS5jb2xvciA9PT1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb2xvci5CTEFDS1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdjJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdDJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICsrZW1wdHlGaWVsZHM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoZW1wdHlGaWVsZHMgPiAwKSB7XG4gICAgICAgICAgICAgICAgZmVuICs9IGVtcHR5RmllbGRzO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmZW4gKz0gJy8nO1xuICAgICAgICB9XG5cbiAgICAgICAgZmVuID0gZmVuLnN1YnN0cigwLCBmZW4ubGVuZ3RoIC0gMSk7XG5cbiAgICAgICAgaWYgKHRoaXMucmV2ZXJ0ZWQpIHtcbiAgICAgICAgICAgIGZlbiA9IGZlbi5zcGxpdCgnJykucmV2ZXJzZSgpLmpvaW4oJycpO1xuICAgICAgICB9XG5cbiAgICAgICAgZmVuICs9ICcgJyArICh0aGlzLmN1cnJlbnRXaGl0ZVBsYXllciA/ICd3JyA6ICdiJyk7XG4gICAgICAgIGNvbnN0IHdoaXRlRW5QYXNzYW50ID0gdGhpcy5nZXRDYXN0bGVGRU5TdHJpbmcoQ29sb3IuV0hJVEUpO1xuICAgICAgICBjb25zdCBibGFja0VuUGFzc2FudCA9IHRoaXMuZ2V0Q2FzdGxlRkVOU3RyaW5nKENvbG9yLkJMQUNLKTtcbiAgICAgICAgbGV0IGNvbmNhdGVkRW5QYXNzYW50ID0gd2hpdGVFblBhc3NhbnQgKyBibGFja0VuUGFzc2FudDtcbiAgICAgICAgaWYgKCFjb25jYXRlZEVuUGFzc2FudCkge1xuICAgICAgICAgICAgY29uY2F0ZWRFblBhc3NhbnQgPSAnLSc7XG4gICAgICAgIH1cblxuICAgICAgICBmZW4gKz0gJyAnICsgY29uY2F0ZWRFblBhc3NhbnQ7XG4gICAgICAgIGZlbiArPSAnICcgKyB0aGlzLmdldEVuUGFzc2FudEZFTlN0cmluZygpO1xuICAgICAgICBmZW4gKz0gJyAnICsgMDtcbiAgICAgICAgZmVuICs9ICcgJyArIHRoaXMuZnVsbE1vdmVDb3VudDtcbiAgICAgICAgdGhpcy5mZW4gPSBmZW47XG4gICAgfVxuXG4gICAgaXNYWUluUG9pbnRTZWxlY3Rpb24oaTogbnVtYmVyLCBqOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmV2ZXJzZVBvaW50KHBvaW50OiBQb2ludCkge1xuICAgICAgICBpZiAocG9pbnQpIHtcbiAgICAgICAgICAgIHBvaW50LnJvdyA9IE1hdGguYWJzKHBvaW50LnJvdyAtIDcpO1xuICAgICAgICAgICAgcG9pbnQuY29sID0gTWF0aC5hYnMocG9pbnQuY29sIC0gNyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0UGllY2VCeVBvaW50KHJvdzogbnVtYmVyLCBjb2w6IG51bWJlcik6IFBpZWNlIHtcbiAgICAgICAgcm93ID0gTWF0aC5mbG9vcihyb3cpO1xuICAgICAgICBjb2wgPSBNYXRoLmZsb29yKGNvbCk7XG4gICAgICAgIHJldHVybiB0aGlzLnBpZWNlcy5maW5kKFxuICAgICAgICAgICAgKHBpZWNlKSA9PiBwaWVjZS5wb2ludC5jb2wgPT09IGNvbCAmJiBwaWVjZS5wb2ludC5yb3cgPT09IHJvdyxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2hlY2tJZlBhd25UYWtlc0VuUGFzc2FudChuZXdQb2ludDogUG9pbnQpIHtcbiAgICAgICAgaWYgKG5ld1BvaW50LmlzRXF1YWwodGhpcy5lblBhc3NhbnRQb2ludCkpIHtcbiAgICAgICAgICAgIHRoaXMucGllY2VzID0gdGhpcy5waWVjZXMuZmlsdGVyKFxuICAgICAgICAgICAgICAgIChwaWVjZSkgPT4gcGllY2UgIT09IHRoaXMuZW5QYXNzYW50UGllY2UsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgdGhpcy5lblBhc3NhbnRQb2ludCA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLmVuUGFzc2FudFBpZWNlID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBjaGVja0lmUGF3bkVucGFzc2FudGVkKHBpZWNlOiBQYXduLCBuZXdQb2ludDogUG9pbnQpIHtcbiAgICAgICAgaWYgKE1hdGguYWJzKHBpZWNlLnBvaW50LnJvdyAtIG5ld1BvaW50LnJvdykgPiAxKSB7XG4gICAgICAgICAgICB0aGlzLmVuUGFzc2FudFBpZWNlID0gcGllY2U7XG4gICAgICAgICAgICB0aGlzLmVuUGFzc2FudFBvaW50ID0gbmV3IFBvaW50KFxuICAgICAgICAgICAgICAgIChwaWVjZS5wb2ludC5yb3cgKyBuZXdQb2ludC5yb3cpIC8gMixcbiAgICAgICAgICAgICAgICBwaWVjZS5wb2ludC5jb2wsXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5lblBhc3NhbnRQb2ludCA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLmVuUGFzc2FudFBpZWNlID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlzS2luZ0NoZWNrZWQocGllY2U6IFBpZWNlKSB7XG4gICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIEtpbmcpIHtcbiAgICAgICAgICAgIHJldHVybiBwaWVjZS5jb2xvciA9PT0gQ29sb3IuV0hJVEVcbiAgICAgICAgICAgICAgICA/IHRoaXMud2hpdGVLaW5nQ2hlY2tlZFxuICAgICAgICAgICAgICAgIDogdGhpcy5ibGFja0tpbmdDaGVja2VkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0Q3VycmVudFBsYXllckNvbG9yKCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRXaGl0ZVBsYXllciA/IENvbG9yLldISVRFIDogQ29sb3IuQkxBQ0s7XG4gICAgfVxufVxuIl19