import { Bishop } from '../models/pieces/bishop';
import { King } from '../models/pieces/king';
import { Knight } from '../models/pieces/knight';
import { Pawn } from '../models/pieces/pawn';
import { Point } from '../models/pieces/point';
import { MoveTranslation } from '../models/move-translation';
import { Queen } from '../models/pieces/queen';
import { Rook } from '../models/pieces/rook';
export class MoveUtils {
    static willMoveCauseCheck(currentColor, row, col, destRow, destCol, board) {
        const srcPiece = board.getPieceByField(row, col);
        const destPiece = board.getPieceByField(destRow, destCol);
        if (srcPiece) {
            srcPiece.point.row = destRow;
            srcPiece.point.col = destCol;
        }
        if (destPiece) {
            board.pieces = board.pieces.filter((piece) => piece !== destPiece);
        }
        const isBound = board.isKingInCheck(currentColor, board.pieces);
        if (srcPiece) {
            srcPiece.point.col = col;
            srcPiece.point.row = row;
        }
        if (destPiece) {
            board.pieces.push(destPiece);
        }
        return isBound;
    }
    static format(sourcePoint, destPoint, reverted) {
        if (reverted) {
            const sourceX = 104 - sourcePoint.col;
            const destX = 104 - destPoint.col;
            return (String.fromCharCode(sourceX) +
                (sourcePoint.row + 1) +
                String.fromCharCode(destX) +
                (destPoint.row + 1));
        }
        else {
            const incrementX = 97;
            return (String.fromCharCode(sourcePoint.col + incrementX) +
                (Math.abs(sourcePoint.row - 7) + 1) +
                String.fromCharCode(destPoint.col + incrementX) +
                (Math.abs(destPoint.row - 7) + 1));
        }
    }
    static translateCoordsToIndex(coords, reverted) {
        let xAxis;
        let yAxis;
        if (reverted) {
            xAxis = 104 - coords.charCodeAt(0);
            yAxis = +coords.charAt(1) - 1;
        }
        else {
            xAxis = coords.charCodeAt(0) - 97;
            yAxis = Math.abs(+coords.charAt(1) - 8);
        }
        return new MoveTranslation(xAxis, yAxis, reverted);
    }
    static findPieceByPossibleMovesContaining(coords, board, color) {
        let indexes = this.translateCoordsToIndex(coords, board.reverted);
        let destPoint = new Point(indexes.yAxis, indexes.xAxis);
        let foundPieces = [];
        for (let piece of board.pieces.filter(piece => piece.color === color)) {
            for (let point of piece.getPossibleMoves()) {
                if (!MoveUtils.willMoveCauseCheck(piece.color, piece.point.row, piece.point.col, indexes.yAxis, indexes.xAxis, board) && point.isEqual(destPoint)) {
                    foundPieces.push(piece);
                }
            }
        }
        return foundPieces;
    }
    static findPieceByPossibleCapturesContaining(coords, board, color) {
        let indexes = this.translateCoordsToIndex(coords, board.reverted);
        let destPoint = new Point(indexes.yAxis, indexes.xAxis);
        let foundPieces = [];
        for (let piece of board.pieces.filter(piece => piece.color === color)) {
            for (let point of piece.getPossibleCaptures()) {
                if (!MoveUtils.willMoveCauseCheck(piece.color, piece.point.row, piece.point.col, indexes.yAxis, indexes.xAxis, board) && point.isEqual(destPoint)) {
                    foundPieces.push(piece);
                }
            }
        }
        return foundPieces;
    }
    static formatSingle(point, reverted) {
        if (reverted) {
            const sourceX = 104 - point.col;
            return (String.fromCharCode(sourceX) +
                (point.row + 1));
        }
        else {
            const incrementX = 97;
            return (String.fromCharCode(point.col + incrementX) +
                (Math.abs(point.row - 7) + 1));
        }
    }
    static getFirstLetterPiece(piece) {
        if (piece instanceof Pawn) {
            return 'P';
        }
        else {
            if (piece instanceof Knight) {
                return 'N';
            }
            else {
                if (piece instanceof Bishop) {
                    return 'B';
                }
                else {
                    if (piece instanceof Rook) {
                        return 'R';
                    }
                    else {
                        if (piece instanceof King) {
                            return 'K';
                        }
                        else {
                            if (piece instanceof Queen) {
                                return 'Q';
                            }
                        }
                    }
                }
            }
        }
        return '';
    }
    static reverse(board, row) {
        return board.reverted
            ? row + 1
            : Math.abs(row - 7) + 1;
    }
    static formatCol(board, col) {
        return board.reverted
            ? String.fromCharCode(104 - col)
            : String.fromCharCode(97 + col);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW92ZS11dGlscy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1jaGVzcy1ib2FyZC9zcmMvbGliL3V0aWxzL21vdmUtdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRWpELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDakQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRTdDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMvQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDN0QsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQy9DLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUU3QyxNQUFNLE9BQU8sU0FBUztJQUNYLE1BQU0sQ0FBQyxrQkFBa0IsQ0FDNUIsWUFBbUIsRUFDbkIsR0FBVyxFQUNYLEdBQVcsRUFDWCxPQUFlLEVBQ2YsT0FBZSxFQUNmLEtBQVk7UUFFWixNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNqRCxNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUUxRCxJQUFJLFFBQVEsRUFBRTtZQUNWLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLE9BQU8sQ0FBQztZQUM3QixRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUM7U0FDaEM7UUFFRCxJQUFJLFNBQVMsRUFBRTtZQUNYLEtBQUssQ0FBQyxNQUFNLEdBQUcs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QUNkO3FCQUFNO29CQUNILElBQUksS0FBSyxZQUFZLElBQUksRUFBRTt3QkFDdkIsT0FBTyxHQUFHLENBQUM7cUJBQ2Q7eUJBQU07d0JBQ0gsSUFBSSxLQUFLLFlBQVksSUFBSSxFQUFFOzRCQUN2QixPQUFPLEdBQUcsQ0FBQzt5QkFDZDs2QkFBTTs0QkFDSCxJQUFJLEtBQUssWUFBWSxLQUFLLEVBQUU7Z0NBQ3hCLE9BQU8sR0FBRyxDQUFDOzZCQUNkO3lCQUNKO3FCQUNKO2lCQUNKO2FBQ0o7U0FDSjtRQUVELE9BQU8sRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVELE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBWSxFQUFFLEdBQVc7UUFDcEMsT0FBTyxLQUFLLENBQUMsUUFBUTtZQUNqQixDQUFDLENBQUMsR0FBRyxHQUFHLENBQUM7WUFDVCxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQVksRUFBRSxHQUFXO1FBQ3RDLE9BQU8sS0FBSyxDQUFDLFFBQVE7WUFDakIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztZQUNoQyxDQUFDLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxFQUFFLEdBQUcsR0FBRyxDQUFDLENBQUM7SUFDeEMsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQm9hcmQgfSBmcm9tICcuLi9tb2RlbHMvYm9hcmQnO1xuaW1wb3J0IHsgQmlzaG9wIH0gZnJvbSAnLi4vbW9kZWxzL3BpZWNlcy9iaXNob3AnO1xuaW1wb3J0IHsgQ29sb3IgfSBmcm9tICcuLi9tb2RlbHMvcGllY2VzL2NvbG9yJztcbmltcG9ydCB7IEtpbmcgfSBmcm9tICcuLi9tb2RlbHMvcGllY2VzL2tpbmcnO1xuaW1wb3J0IHsgS25pZ2h0IH0gZnJvbSAnLi4vbW9kZWxzL3BpZWNlcy9rbmlnaHQnO1xuaW1wb3J0IHsgUGF3biB9IGZyb20gJy4uL21vZGVscy9waWVjZXMvcGF3bic7XG5pbXBvcnQgeyBQaWVjZSB9IGZyb20gJy4uL21vZGVscy9waWVjZXMvcGllY2UnO1xuaW1wb3J0IHsgUG9pbnQgfSBmcm9tICcuLi9tb2RlbHMvcGllY2VzL3BvaW50JztcbmltcG9ydCB7IE1vdmVUcmFuc2xhdGlvbiB9IGZyb20gJy4uL21vZGVscy9tb3ZlLXRyYW5zbGF0aW9uJztcbmltcG9ydCB7IFF1ZWVuIH0gZnJvbSAnLi4vbW9kZWxzL3BpZWNlcy9xdWVlbic7XG5pbXBvcnQgeyBSb29rIH0gZnJvbSAnLi4vbW9kZWxzL3BpZWNlcy9yb29rJztcblxuZXhwb3J0IGNsYXNzIE1vdmVVdGlscyB7XG4gICAgcHVibGljIHN0YXRpYyB3aWxsTW92ZUNhdXNlQ2hlY2soXG4gICAgICAgIGN1cnJlbnRDb2xvcjogQ29sb3IsXG4gICAgICAgIHJvdzogbnVtYmVyLFxuICAgICAgICBjb2w6IG51bWJlcixcbiAgICAgICAgZGVzdFJvdzogbnVtYmVyLFxuICAgICAgICBkZXN0Q29sOiBudW1iZXIsXG4gICAgICAgIGJvYXJkOiBCb2FyZFxuICAgICkge1xuICAgICAgICBjb25zdCBzcmNQaWVjZSA9IGJvYXJkLmdldFBpZWNlQnlGaWVsZChyb3csIGNvbCk7XG4gICAgICAgIGNvbnN0IGRlc3RQaWVjZSA9IGJvYXJkLmdldFBpZWNlQnlGaWVsZChkZXN0Um93LCBkZXN0Q29sKTtcblxuICAgICAgICBpZiAoc3JjUGllY2UpIHtcbiAgICAgICAgICAgIHNyY1BpZWNlLnBvaW50LnJvdyA9IGRlc3RSb3c7XG4gICAgICAgICAgICBzcmNQaWVjZS5wb2ludC5jb2wgPSBkZXN0Q29sO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRlc3RQaWVjZSkge1xuICAgICAgICAgICAgYm9hcmQucGllY2VzID0gYm9hcmQucGllY2VzLmZpbHRlcigocGllY2UpID0+IHBpZWNlICE9PSBkZXN0UGllY2UpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGlzQm91bmQgPSBib2FyZC5pc0tpbmdJbkNoZWNrKGN1cnJlbnRDb2xvciwgYm9hcmQucGllY2VzKTtcblxuICAgICAgICBpZiAoc3JjUGllY2UpIHtcbiAgICAgICAgICAgIHNyY1BpZWNlLnBvaW50LmNvbCA9IGNvbDtcbiAgICAgICAgICAgIHNyY1BpZWNlLnBvaW50LnJvdyA9IHJvdztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChkZXN0UGllY2UpIHtcbiAgICAgICAgICAgIGJvYXJkLnBpZWNlcy5wdXNoKGRlc3RQaWVjZSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaXNCb3VuZDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGZvcm1hdChcbiAgICAgICAgc291cmNlUG9pbnQ6IFBvaW50LFxuICAgICAgICBkZXN0UG9pbnQ6IFBvaW50LFxuICAgICAgICByZXZlcnRlZDogYm9vbGVhblxuICAgICkge1xuICAgICAgICBpZiAocmV2ZXJ0ZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZVggPSAxMDQgLSBzb3VyY2VQb2ludC5jb2w7XG4gICAgICAgICAgICBjb25zdCBkZXN0WCA9IDEwNCAtIGRlc3RQb2ludC5jb2w7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoc291cmNlWCkgK1xuICAgICAgICAgICAgICAgIChzb3VyY2VQb2ludC5yb3cgKyAxKSArXG4gICAgICAgICAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZShkZXN0WCkgK1xuICAgICAgICAgICAgICAgIChkZXN0UG9pbnQucm93ICsgMSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBpbmNyZW1lbnRYID0gOTc7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoc291cmNlUG9pbnQuY29sICsgaW5jcmVtZW50WCkgK1xuICAgICAgICAgICAgICAgIChNYXRoLmFicyhzb3VyY2VQb2ludC5yb3cgLSA3KSArIDEpICtcbiAgICAgICAgICAgICAgICBTdHJpbmcuZnJvbUNoYXJDb2RlKGRlc3RQb2ludC5jb2wgKyBpbmNyZW1lbnRYKSArXG4gICAgICAgICAgICAgICAgKE1hdGguYWJzKGRlc3RQb2ludC5yb3cgLSA3KSArIDEpXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyB0cmFuc2xhdGVDb29yZHNUb0luZGV4KGNvb3Jkczogc3RyaW5nLCByZXZlcnRlZDogYm9vbGVhbikge1xuICAgICAgICBsZXQgeEF4aXM6IG51bWJlcjtcbiAgICAgICAgbGV0IHlBeGlzOiBudW1iZXI7XG4gICAgICAgIGlmIChyZXZlcnRlZCkge1xuICAgICAgICAgICAgeEF4aXMgPSAxMDQgLSBjb29yZHMuY2hhckNvZGVBdCgwKTtcbiAgICAgICAgICAgIHlBeGlzID0gK2Nvb3Jkcy5jaGFyQXQoMSkgLSAxO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgeEF4aXMgPSBjb29yZHMuY2hhckNvZGVBdCgwKSAtIDk3O1xuICAgICAgICAgICAgeUF4aXMgPSBNYXRoLmFicygrY29vcmRzLmNoYXJBdCgxKSAtIDgpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5ldyBNb3ZlVHJhbnNsYXRpb24oeEF4aXMsIHlBeGlzLCByZXZlcnRlZCk7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBmaW5kUGllY2VCeVBvc3NpYmxlTW92ZXNDb250YWluaW5nKFxuICAgICAgICBjb29yZHM6IHN0cmluZyxcbiAgICAgICAgYm9hcmQ6IEJvYXJkLFxuICAgICAgICBjb2xvcjogQ29sb3JcbiAgICApOiBQaWVjZVtdIHtcbiAgICAgICAgbGV0IGluZGV4ZXMgPSB0aGlzLnRyYW5zbGF0ZUNvb3Jkc1RvSW5kZXgoY29vcmRzLCBib2FyZC5yZXZlcnRlZCk7XG4gICAgICAgIGxldCBkZXN0UG9pbnQgPSBuZXcgUG9pbnQoaW5kZXhlcy55QXhpcywgaW5kZXhlcy54QXhpcyk7XG4gICAgICAgIGxldCBmb3VuZFBpZWNlcyA9IFtdO1xuXG4gICAgICAgIGZvciAobGV0IHBpZWNlIG9mIGJvYXJkLnBpZWNlcy5maWx0ZXIocGllY2UgPT4gcGllY2UuY29sb3IgPT09IGNvbG9yKSkge1xuICAgICAgICAgICAgZm9yIChsZXQgcG9pbnQgb2YgcGllY2UuZ2V0UG9zc2libGVNb3ZlcygpKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFNb3ZlVXRpbHMud2lsbE1vdmVDYXVzZUNoZWNrKFxuICAgICAgICAgICAgICAgICAgICBwaWVjZS5jb2xvcixcbiAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQucm93LFxuICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludC5jb2wsXG4gICAgICAgICAgICAgICAgICAgIGluZGV4ZXMueUF4aXMsXG4gICAgICAgICAgICAgICAgICAgIGluZGV4ZXMueEF4aXMsXG4gICAgICAgICAgICAgICAgICAgIGJvYXJkXG4gICAgICAgICAgICAgICAgKSAmJiBwb2ludC5pc0VxdWFsKGRlc3RQb2ludCkpIHtcbiAgICAgICAgICAgICAgICAgICAgZm91bmRQaWVjZXMucHVzaChwaWVjZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmb3VuZFBpZWNlcztcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGZpbmRQaWVjZUJ5UG9zc2libGVDYXB0dXJlc0NvbnRhaW5pbmcoXG4gICAgICAgIGNvb3Jkczogc3RyaW5nLFxuICAgICAgICBib2FyZDogQm9hcmQsXG4gICAgICAgIGNvbG9yOiBDb2xvclxuICAgICk6IFBpZWNlW10ge1xuICAgICAgICBsZXQgaW5kZXhlcyA9IHRoaXMudHJhbnNsYXRlQ29vcmRzVG9JbmRleChjb29yZHMsIGJvYXJkLnJldmVydGVkKTtcbiAgICAgICAgbGV0IGRlc3RQb2ludCA9IG5ldyBQb2ludChpbmRleGVzLnlBeGlzLCBpbmRleGVzLnhBeGlzKTtcbiAgICAgICAgbGV0IGZvdW5kUGllY2VzID0gW107XG4gICAgICAgIGZvciAobGV0IHBpZWNlIG9mIGJvYXJkLnBpZWNlcy5maWx0ZXIocGllY2UgPT4gcGllY2UuY29sb3IgPT09IGNvbG9yKSkge1xuICAgICAgICAgICAgZm9yIChsZXQgcG9pbnQgb2YgcGllY2UuZ2V0UG9zc2libGVDYXB0dXJlcygpKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFNb3ZlVXRpbHMud2lsbE1vdmVDYXVzZUNoZWNrKFxuICAgICAgICAgICAgICAgICAgICBwaWVjZS5jb2xvcixcbiAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQucm93LFxuICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludC5jb2wsXG4gICAgICAgICAgICAgICAgICAgIGluZGV4ZXMueUF4aXMsXG4gICAgICAgICAgICAgICAgICAgIGluZGV4ZXMueEF4aXMsXG4gICAgICAgICAgICAgICAgICAgIGJvYXJkXG4gICAgICAgICAgICAgICAgKSAmJiBwb2ludC5pc0VxdWFsKGRlc3RQb2ludCkpIHtcbiAgICAgICAgICAgICAgICAgICAgZm91bmRQaWVjZXMucHVzaChwaWVjZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGZvdW5kUGllY2VzO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZm9ybWF0U2luZ2xlKHBvaW50OiBQb2ludCwgcmV2ZXJ0ZWQ6IGJvb2xlYW4pOiBzdHJpbmcge1xuICAgICAgICBpZiAocmV2ZXJ0ZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZVggPSAxMDQgLSBwb2ludC5jb2w7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUoc291cmNlWCkgK1xuICAgICAgICAgICAgICAgIChwb2ludC5yb3cgKyAxKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGluY3JlbWVudFggPSA5NztcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZShwb2ludC5jb2wgKyBpbmNyZW1lbnRYKSArXG4gICAgICAgICAgICAgICAgKE1hdGguYWJzKHBvaW50LnJvdyAtIDcpICsgMSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldEZpcnN0TGV0dGVyUGllY2UocGllY2U6IFBpZWNlKTogc3RyaW5nIHtcbiAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgUGF3bikge1xuICAgICAgICAgICAgcmV0dXJuICdQJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIEtuaWdodCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAnTic7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIEJpc2hvcCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ0InO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIFJvb2spIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnUic7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBLaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdLJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgUXVlZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdRJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgc3RhdGljIHJldmVyc2UoYm9hcmQ6IEJvYXJkLCByb3c6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gYm9hcmQucmV2ZXJ0ZWRcbiAgICAgICAgICAgID8gcm93ICsgMVxuICAgICAgICAgICAgOiBNYXRoLmFicyhyb3cgLSA3KSArIDE7XG4gICAgfVxuXG4gICAgc3RhdGljIGZvcm1hdENvbChib2FyZDogQm9hcmQsIGNvbDogbnVtYmVyKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGJvYXJkLnJldmVydGVkXG4gICAgICAgICAgICA/IFN0cmluZy5mcm9tQ2hhckNvZGUoMTA0IC0gY29sKVxuICAgICAgICAgICAgOiBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3ICsgY29sKTtcbiAgICB9XG59XG4iXX0=