import { Bishop } from '../../../../../models/pieces/bishop';
import { Color } from '../../../../../models/pieces/color';
import { King } from '../../../../../models/pieces/king';
import { Knight } from '../../../../../models/pieces/knight';
import { Pawn } from '../../../../../models/pieces/pawn';
import { Point } from '../../../../../models/pieces/point';
import { Queen } from '../../../../../models/pieces/queen';
import { Rook } from '../../../../../models/pieces/rook';
import { Coin } from '../../../../../models/pieces/coin';
import { MoveUtils } from '../../../../../utils/move-utils';
import { DefaultPiecesLoader } from '../../default-pieces-loader';
export class DefaultPgnProcessor {
    process(notation, engineFacade) {
        if (notation) {
            engineFacade.board.reverted = false;
            engineFacade.board.pieces = [];
            engineFacade.reset();
            DefaultPiecesLoader.loadDefaultPieces(engineFacade.board);
            let moves = this.extractMoves(notation);
            let counter = -1;
            for (let move of moves) {
                ++counter;
                move = move.replace(/[+#]/g, '');
                let promotionIndex = '';
                if (move.includes('=')) {
                    promotionIndex = this.resolvePromotion(move.substring(move.length - 1));
                    move = move.substring(0, move.length - 2);
                }
                let color = counter === 0 || counter % 2 === 0
                    ? Color.WHITE
                    : Color.BLACK;
                if (/^[a-z]\d$/g.test(move)) {
                    // zwykly ruch na wolne pole e4
                    let piece = MoveUtils.findPieceByPossibleMovesContaining(move, engineFacade.board, color).find((piece) => piece instanceof Pawn);
                    // en passant check
                    if (!piece) {
                        piece = MoveUtils.findPieceByPossibleCapturesContaining(move, engineFacade.board, color).find((piece) => piece instanceof Pawn);
                    }
                    // if piece is found for sure
                    if (piece) {
                        engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                            move +
                            promotionIndex);
                    }
                }
                else {
                    if (/^[A-Z][a-h]\d$/g.test(move)) {
                        // jezeli ma wielka litere, czyli trzeba odszukac ktora figura Nf3
                        let pieces = MoveUtils.findPieceByPossibleMovesContaining(move.substring(1), engineFacade.board, color);
                        let piece = pieces.find((piece) => this.resolvePieceByFirstChar(move.charAt(0), piece));
                        if (piece) {
                            engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                                move.substring(1) +
                                promotionIndex);
                        }
                        else {
                        }
                    }
                    else {
                        if ('O-O' === move) {
                            engineFacade.move(color === Color.WHITE ? 'e1g1' : 'e8g8');
                        }
                        else {
                            if (/^[a-z]x[a-z]\d$/g.test(move)) {
                                //exd5
                                let pieces = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).filter((piece) => piece instanceof Pawn);
                                let piece;
                                if (pieces.length > 1) {
                                    piece = this.resolveByCol(pieces, move.substring(0, 1));
                                }
                                else {
                                    piece = pieces[0];
                                }
                                if (piece) {
                                    engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                                        move.substring(move.indexOf('x') + 1) +
                                        promotionIndex);
                                }
                                else {
                                }
                            }
                            else {
                                if (/^[A-Z]x[a-z]\d$/g.test(move)) {
                                    let piece = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).find((piece) => this.resolvePieceByFirstChar(move.substring(0, 1), piece));
                                    if (piece) {
                                        engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                                            move.substring(move.indexOf('x') + 1) +
                                            promotionIndex);
                                    }
                                    else {
                                    }
                                }
                                else {
                                    if (move === 'O-O-O') {
                                        engineFacade.move(color === Color.WHITE
                                            ? 'e1c1'
                                            : 'e8c8');
                                    }
                                    else {
                                        if (/^[A-Z]\dx[a-z]\d$/g.test(move)) {
                                            //Ngxe4 sytuacja 2 skoczkow pion bicie
                                            let pieces = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).filter((piece) => this.resolvePieceByFirstChar(move.charAt(0), piece));
                                            let piece = this.resolveByRow(pieces, move.substring(1, 2));
                                            if (piece) {
                                                engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                                                    move.substring(move.indexOf('x') +
                                                        1) +
                                                    promotionIndex);
                                            }
                                        }
                                        else {
                                            if (/^[A-Z][a-z][a-z]\d$/g.test(move)) {
                                                // dwie wieze bez bicia Rac1 pion
                                                let pieces = MoveUtils.findPieceByPossibleMovesContaining(move.substring(2, 4), engineFacade.board, color).filter((piece) => this.resolvePieceByFirstChar(move.charAt(0), piece));
                                                let piece = this.resolveByCol(pieces, move.substring(1, 2));
                                                if (piece) {
                                                    engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                                                        move.substring(2, 4) +
                                                        promotionIndex);
                                                }
                                            }
                                            else {
                                                if (/^[A-Z][a-z]x[a-z]\d$/g.test(move)) {
                                                    let pieces = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).filter((piece) => this.resolvePieceByFirstChar(move.charAt(0), piece));
                                                    let piece = this.resolveByCol(pieces, move.substring(1, 2));
                                                    if (piece) {
                                                        engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                                                            move.substring(move.indexOf('x') + 1) +
                                                            promotionIndex);
                                                    }
                                                }
                                                else {
                                                    this.processR1f2(move, engineFacade, color, promotionIndex);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    processR1f2(move, engineFacade, color, promotionIndex) {
        if (/^[A-Z]\d[a-z]\d$/g.test(move)) {
            // R1f2
            let pieces = MoveUtils.findPieceByPossibleMovesContaining(move.substring(2, 4), engineFacade.board, color).filter((piece) => this.resolvePieceByFirstChar(move.charAt(0), piece));
            let piece = this.resolveByRow(pieces, move.substring(1, 2));
            if (piece) {
                engineFacade.move(MoveUtils.formatSingle(piece.point, false) +
                    move.substring(2, 4) +
                    promotionIndex);
            }
        }
    }
    extractMoves(notation) {
        return notation
            .substring(notation.lastIndexOf(']') + 1)
            .replace(/[0-9]+\./g, '')
            .replace(/\s+/g, ' ')
            .replace(/{[^}]*}/g, '')
            .trim()
            .split(' ')
            .filter((s) => s);
    }
    movePiece(piece, board, move) {
        let indexes = MoveUtils.translateCoordsToIndex(move, board.reverted);
        piece.point.col = indexes.xAxis;
        piece.point.row = indexes.yAxis;
    }
    hasUpperCase(move) {
        return /[A-Z]/.test(move);
    }
    resolvePieceByFirstChar(move, piece) {
        let piecesFirstChar = '';
        if (piece instanceof King) {
            piecesFirstChar = 'K';
        }
        else {
            if (piece instanceof Queen) {
                piecesFirstChar = 'Q';
            }
            else {
                if (piece instanceof Rook) {
                    piecesFirstChar = 'R';
                }
                else {
                    if (piece instanceof Bishop) {
                        piecesFirstChar = 'B';
                    }
                    else {
                        if (piece instanceof Knight) {
                            piecesFirstChar = 'N';
                        }
                        else {
                            if (piece instanceof Pawn) {
                                piecesFirstChar = 'P';
                            }
                            else {
                                if (piece instanceof Coin) {
                                    piecesFirstChar = 'C';
                                }
                            }
                        }
                    }
                }
            }
        }
        return move === piecesFirstChar;
    }
    isShortCastle(move) {
        return move === 'O-O';
    }
    removePiece(coords, board) {
        let indexes = MoveUtils.translateCoordsToIndex(coords, board.reverted);
        board.pieces = board.pieces.filter((e) => !e.point.isEqual(new Point(indexes.yAxis, indexes.xAxis)));
    }
    isLongCastle(move) {
        return move === 'O-O-O';
    }
    resolveByCol(pieces, char) {
        let firstPieceFormat = MoveUtils.formatSingle(pieces[0].point, false);
        let secondPieceFormat = MoveUtils.formatSingle(pieces[1].point, false);
        return firstPieceFormat.substring(0, 1) === char
            ? pieces[0]
            : pieces[1];
    }
    resolveByRow(pieces, char) {
        let firstPieceFormat = MoveUtils.formatSingle(pieces[0].point, false);
        let secondPieceFormat = MoveUtils.formatSingle(pieces[1].point, false);
        return firstPieceFormat.substring(1, 2) === char
            ? pieces[0]
            : pieces[1];
    }
    replacePromotion(move) {
        return move
            .replace('=Q', '1')
            .replace('=R', '2')
            .replace('=B', '3')
            .replace('=K', '4');
    }
    resolvePromotion(promotionChar) {
        switch (promotionChar) {
            case 'Q':
                return '1';
            case 'R':
                return '2';
            case 'B':
                return '3';
            case 'N':
                return '4';
        }
        return '';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1wZ24tcHJvY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWNoZXNzLWJvYXJkL3NyYy9saWIvZW5naW5lL2JvYXJkLXN0YXRlLXByb3ZpZGVyL2JvYXJkLWxvYWRlci9ub3RhdGlvbi1wcm9jZXNzb3JzL3Bnbi1sb2FkZXIvZGVmYXVsdC1wZ24tcHJvY2Vzc29yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3RCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDM0QsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ3pELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFFekQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQzNELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUMzRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDekQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ3pELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUU1RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUdsRSxNQUFNLE9BQU8sbUJBQW1CO0lBQ3JCLE9BQU8sQ0FBQyxRQUFnQixFQUFFLFlBQWtDO1FBQy9ELElBQUksUUFBUSxFQUFFO1lBQ1YsWUFBWSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO1lBQ3BDLFlBQVksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztZ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LENBQUMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdEUsSUFBSSxpQkFBaUIsR0FBRyxTQUFTLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdkUsT0FBTyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUk7WUFDNUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDWCxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3BCLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxJQUFZO1FBQ2pDLE9BQU8sSUFBSTthQUNOLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDO2FBQ2xCLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDO2FBQ2xCLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDO2FBQ2xCLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVPLGdCQUFnQixDQUFDLGFBQXFCO1FBQzFDLFFBQVEsYUFBYSxFQUFFO1lBQ25CLEtBQUssR0FBRztnQkFDSixPQUFPLEdBQUcsQ0FBQztZQUNmLEtBQUssR0FBRztnQkFDSixPQUFPLEdBQUcsQ0FBQztZQUNmLEtBQUssR0FBRztnQkFDSixPQUFPLEdBQUcsQ0FBQztZQUNmLEtBQUssR0FBRztnQkFDSixPQUFPLEdBQUcsQ0FBQztTQUNsQjtRQUNELE9BQU8sRUFBRSxDQUFDO0lBQ2QsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQm9hcmQgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvYm9hcmQnO1xuaW1wb3J0IHsgQmlzaG9wIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vbW9kZWxzL3BpZWNlcy9iaXNob3AnO1xuaW1wb3J0IHsgQ29sb3IgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL2NvbG9yJztcbmltcG9ydCB7IEtpbmcgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL2tpbmcnO1xuaW1wb3J0IHsgS25pZ2h0IH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vbW9kZWxzL3BpZWNlcy9rbmlnaHQnO1xuaW1wb3J0IHsgUGF3biB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMvcGF3bic7XG5pbXBvcnQgeyBQaWVjZSB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMvcGllY2UnO1xuaW1wb3J0IHsgUG9pbnQgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL3BvaW50JztcbmltcG9ydCB7IFF1ZWVuIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vbW9kZWxzL3BpZWNlcy9xdWVlbic7XG5pbXBvcnQgeyBSb29rIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vbW9kZWxzL3BpZWNlcy9yb29rJztcbmltcG9ydCB7IENvaW4gfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL2NvaW4nO1xuaW1wb3J0IHsgTW92ZVV0aWxzIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vdXRpbHMvbW92ZS11dGlscyc7XG5pbXBvcnQgeyBBYnN0cmFjdEVuZ2luZUZhY2FkZSB9IGZyb20gJy4uLy4uLy4uLy4uL2Fic3RyYWN0LWVuZ2luZS1mYWNhZGUnO1xuaW1wb3J0IHsgRGVmYXVsdFBpZWNlc0xvYWRlciB9IGZyb20gJy4uLy4uL2RlZmF1bHQtcGllY2VzLWxvYWRlcic7XG5pbXBvcnQgeyBOb3RhdGlvblByb2Nlc3NvciB9IGZyb20gJy4uL25vdGF0aW9uLXByb2Nlc3Nvcic7XG5cbmV4cG9ydCBjbGFzcyBEZWZhdWx0UGduUHJvY2Vzc29yIGltcGxlbWVudHMgTm90YXRpb25Qcm9jZXNzb3Ige1xuICAgIHB1YmxpYyBwcm9jZXNzKG5vdGF0aW9uOiBzdHJpbmcsIGVuZ2luZUZhY2FkZTogQWJzdHJhY3RFbmdpbmVGYWNhZGUpOiB2b2lkIHtcbiAgICAgICAgaWYgKG5vdGF0aW9uKSB7XG4gICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQucmV2ZXJ0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZC5waWVjZXMgPSBbXTtcbiAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5yZXNldCgpO1xuICAgICAgICAgICAgRGVmYXVsdFBpZWNlc0xvYWRlci5sb2FkRGVmYXVsdFBpZWNlcyhlbmdpbmVGYWNhZGUuYm9hcmQpO1xuICAgICAgICAgICAgbGV0IG1vdmVzID0gdGhpcy5leHRyYWN0TW92ZXMobm90YXRpb24pO1xuICAgICAgICAgICAgbGV0IGNvdW50ZXIgPSAtMTtcbiAgICAgICAgICAgIGZvciAobGV0IG1vdmUgb2YgbW92ZXMpIHtcbiAgICAgICAgICAgICAgICArK2NvdW50ZXI7XG4gICAgICAgICAgICAgICAgbW92ZSA9IG1vdmUucmVwbGFjZSgvWysjXS9nLCAnJyk7XG4gICAgICAgICAgICAgICAgbGV0IHByb21vdGlvbkluZGV4ID0gJyc7XG5cbiAgICAgICAgICAgICAgICBpZiAobW92ZS5pbmNsdWRlcygnPScpKSB7XG4gICAgICAgICAgICAgICAgICAgIHByb21vdGlvbkluZGV4ID0gdGhpcy5yZXNvbHZlUHJvbW90aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcobW92ZS5sZW5ndGggLSAxKSxcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgbW92ZSA9IG1vdmUuc3Vic3RyaW5nKDAsIG1vdmUubGVuZ3RoIC0gMik7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgbGV0IGNvbG9yID1cbiAgICAgICAgICAgICAgICAgICAgY291bnRlciA9PT0gMCB8fCBjb3VudGVyICUgMiA9PT0gMFxuICAgICAgICAgICAgICAgICAgICAgICAgPyBDb2xvci5XSElURVxuICAgICAgICAgICAgICAgICAgICAgICAgOiBDb2xvci5CTEFDSztcblxuICAgICAgICAgICAgICAgIGlmICgvXlthLXpdXFxkJC9nLnRlc3QobW92ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gend5a2x5IHJ1Y2ggbmEgd29sbmUgcG9sZSBlNFxuICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2UgPSBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZU1vdmVzQ29udGFpbmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUsXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xvcixcbiAgICAgICAgICAgICAgICAgICAgKS5maW5kKChwaWVjZSkgPT4gcGllY2UgaW5zdGFuY2VvZiBQYXduKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBlbiBwYXNzYW50IGNoZWNrXG4gICAgICAgICAgICAgICAgICAgIGlmICghcGllY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlID0gTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVDYXB0dXJlc0NvbnRhaW5pbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICApLmZpbmQoKHBpZWNlKSA9PiBwaWVjZSBpbnN0YW5jZW9mIFBhd24pO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gaWYgcGllY2UgaXMgZm91bmQgZm9yIHN1cmVcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKHBpZWNlLnBvaW50LCBmYWxzZSkgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbW90aW9uSW5kZXgsXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKC9eW0EtWl1bYS1oXVxcZCQvZy50ZXN0KG1vdmUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBqZXplbGkgbWEgd2llbGthIGxpdGVyZSwgY3p5bGkgdHJ6ZWJhIG9kc3p1a2FjIGt0b3JhIGZpZ3VyYSBOZjNcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZXMgPVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlTW92ZXNDb250YWluaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygxKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLmJvYXJkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlID0gcGllY2VzLmZpbmQoKHBpZWNlKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVzb2x2ZVBpZWNlQnlGaXJzdENoYXIobW92ZS5jaGFyQXQoMCksIHBpZWNlKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShwaWVjZS5wb2ludCwgZmFsc2UpICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDEpICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21vdGlvbkluZGV4LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCdPLU8nID09PSBtb3ZlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLm1vdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yID09PSBDb2xvci5XSElURSA/ICdlMWcxJyA6ICdlOGc4JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoL15bYS16XXhbYS16XVxcZCQvZy50ZXN0KG1vdmUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vZXhkNVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2VzID1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlQ2FwdHVyZXNDb250YWluaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKG1vdmUuaW5kZXhPZigneCcpICsgMSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLmJvYXJkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKS5maWx0ZXIoKHBpZWNlKSA9PiBwaWVjZSBpbnN0YW5jZW9mIFBhd24pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlcy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZSA9IHRoaXMucmVzb2x2ZUJ5Q29sKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygwLCAxKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZSA9IHBpZWNlc1swXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLm1vdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuaW5kZXhPZigneCcpICsgMSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21vdGlvbkluZGV4LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgvXltBLVpdeFthLXpdXFxkJC9nLnRlc3QobW92ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZSA9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVDYXB0dXJlc0NvbnRhaW5pbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5pbmRleE9mKCd4JykgKyAxLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkuZmluZCgocGllY2UpID0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVzb2x2ZVBpZWNlQnlGaXJzdENoYXIoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygwLCAxKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5pbmRleE9mKCd4JykgKyAxLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9tb3Rpb25JbmRleCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb3ZlID09PSAnTy1PLU8nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLm1vdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yID09PSBDb2xvci5XSElURVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAnZTFjMSdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJ2U4YzgnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgvXltBLVpdXFxkeFthLXpdXFxkJC9nLnRlc3QobW92ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9OZ3hlNCBzeXR1YWNqYSAyIHNrb2N6a293IHBpb24gYmljaWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlcyA9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZUNhcHR1cmVzQ29udGFpbmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5pbmRleE9mKCd4JykgKyAxLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLmJvYXJkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKS5maWx0ZXIoKHBpZWNlKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVzb2x2ZVBpZWNlQnlGaXJzdENoYXIoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuY2hhckF0KDApLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2UgPSB0aGlzLnJlc29sdmVCeVJvdyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDEsIDIpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLm1vdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UucG9pbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuaW5kZXhPZigneCcpICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbW90aW9uSW5kZXgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgL15bQS1aXVthLXpdW2Etel1cXGQkL2cudGVzdChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGR3aWUgd2llemUgYmV6IGJpY2lhIFJhYzEgcGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlcyA9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVNb3Zlc0NvbnRhaW5pbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDIsIDQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkuZmlsdGVyKChwaWVjZSkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNvbHZlUGllY2VCeUZpcnN0Q2hhcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuY2hhckF0KDApLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlID0gdGhpcy5yZXNvbHZlQnlDb2woXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDEsIDIpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLm1vdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgNCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbW90aW9uSW5kZXgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvXltBLVpdW2Etel14W2Etel1cXGQkL2cudGVzdChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2VzID1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVDYXB0dXJlc0NvbnRhaW5pbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLmluZGV4T2YoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd4JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgMSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKS5maWx0ZXIoKHBpZWNlKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNvbHZlUGllY2VCeUZpcnN0Q2hhcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLmNoYXJBdCgwKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2UgPVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc29sdmVCeUNvbChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLm1vdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuaW5kZXhPZihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd4JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArIDEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbW90aW9uSW5kZXgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NSMWYyKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9tb3Rpb25JbmRleCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwcm9jZXNzUjFmMihtb3ZlLCBlbmdpbmVGYWNhZGUsIGNvbG9yLCBwcm9tb3Rpb25JbmRleCkge1xuICAgICAgICBpZiAoL15bQS1aXVxcZFthLXpdXFxkJC9nLnRlc3QobW92ZSkpIHtcbiAgICAgICAgICAgIC8vIFIxZjJcbiAgICAgICAgICAgIGxldCBwaWVjZXMgPSBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZU1vdmVzQ29udGFpbmluZyhcbiAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygyLCA0KSxcbiAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQsXG4gICAgICAgICAgICAgICAgY29sb3IsXG4gICAgICAgICAgICApLmZpbHRlcigocGllY2UpID0+XG4gICAgICAgICAgICAgICAgdGhpcy5yZXNvbHZlUGllY2VCeUZpcnN0Q2hhcihtb3ZlLmNoYXJBdCgwKSwgcGllY2UpLFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgbGV0IHBpZWNlID0gdGhpcy5yZXNvbHZlQnlSb3cocGllY2VzLCBtb3ZlLnN1YnN0cmluZygxLCAyKSk7XG5cbiAgICAgICAgICAgIGlmIChwaWVjZSkge1xuICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5tb3ZlKFxuICAgICAgICAgICAgICAgICAgICBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKHBpZWNlLnBvaW50LCBmYWxzZSkgK1xuICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoMiwgNCkgK1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvbW90aW9uSW5kZXgsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBleHRyYWN0TW92ZXMobm90YXRpb246IHN0cmluZykge1xuICAgICAgICByZXR1cm4gbm90YXRpb25cbiAgICAgICAgICAgIC5zdWJzdHJpbmcobm90YXRpb24ubGFzdEluZGV4T2YoJ10nKSArIDEpXG4gICAgICAgICAgICAucmVwbGFjZSgvWzAtOV0rXFwuL2csICcnKVxuICAgICAgICAgICAgLnJlcGxhY2UoL1xccysvZywgJyAnKVxuICAgICAgICAgICAgLnJlcGxhY2UoL3tbXn1dKn0vZywgJycpXG4gICAgICAgICAgICAudHJpbSgpXG4gICAgICAgICAgICAuc3BsaXQoJyAnKVxuICAgICAgICAgICAgLmZpbHRlcigocykgPT4gcyk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIG1vdmVQaWVjZShwaWVjZTogUGllY2UsIGJvYXJkOiBCb2FyZCwgbW92ZTogc3RyaW5nKSB7XG4gICAgICAgIGxldCBpbmRleGVzID0gTW92ZVV0aWxzLnRyYW5zbGF0ZUNvb3Jkc1RvSW5kZXgobW92ZSwgYm9hcmQucmV2ZXJ0ZWQpO1xuICAgICAgICBwaWVjZS5wb2ludC5jb2wgPSBpbmRleGVzLnhBeGlzO1xuICAgICAgICBwaWVjZS5wb2ludC5yb3cgPSBpbmRleGVzLnlBeGlzO1xuICAgIH1cblxuICAgIGhhc1VwcGVyQ2FzZShtb3ZlOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIC9bQS1aXS8udGVzdChtb3ZlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlc29sdmVQaWVjZUJ5Rmlyc3RDaGFyKG1vdmU6IHN0cmluZywgcGllY2U6IFBpZWNlKSB7XG4gICAgICAgIGxldCBwaWVjZXNGaXJzdENoYXIgPSAnJztcbiAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgS2luZykge1xuICAgICAgICAgICAgcGllY2VzRmlyc3RDaGFyID0gJ0snO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgUXVlZW4pIHtcbiAgICAgICAgICAgICAgICBwaWVjZXNGaXJzdENoYXIgPSAnUSc7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIFJvb2spIHtcbiAgICAgICAgICAgICAgICAgICAgcGllY2VzRmlyc3RDaGFyID0gJ1InO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIEJpc2hvcCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzRmlyc3RDaGFyID0gJ0InO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgS25pZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzRmlyc3RDaGFyID0gJ04nO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBQYXduKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlc0ZpcnN0Q2hhciA9ICdQJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBDb2luKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZXNGaXJzdENoYXIgPSAnQyc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG1vdmUgPT09IHBpZWNlc0ZpcnN0Q2hhcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzU2hvcnRDYXN0bGUobW92ZTogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBtb3ZlID09PSAnTy1PJztcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbW92ZVBpZWNlKGNvb3Jkczogc3RyaW5nLCBib2FyZDogQm9hcmQpIHtcbiAgICAgICAgbGV0IGluZGV4ZXMgPSBNb3ZlVXRpbHMudHJhbnNsYXRlQ29vcmRzVG9JbmRleChjb29yZHMsIGJvYXJkLnJldmVydGVkKTtcblxuICAgICAgICBib2FyZC5waWVjZXMgPSBib2FyZC5waWVjZXMuZmlsdGVyKFxuICAgICAgICAgICAgKGUpID0+ICFlLnBvaW50LmlzRXF1YWwobmV3IFBvaW50KGluZGV4ZXMueUF4aXMsIGluZGV4ZXMueEF4aXMpKSxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzTG9uZ0Nhc3RsZShtb3ZlOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIG1vdmUgPT09ICdPLU8tTyc7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZXNvbHZlQnlDb2wocGllY2VzOiBQaWVjZVtdLCBjaGFyOiBzdHJpbmcpOiBQaWVjZSB7XG4gICAgICAgIGxldCBmaXJzdFBpZWNlRm9ybWF0ID0gTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShwaWVjZXNbMF0ucG9pbnQsIGZhbHNlKTtcbiAgICAgICAgbGV0IHNlY29uZFBpZWNlRm9ybWF0ID0gTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShwaWVjZXNbMV0ucG9pbnQsIGZhbHNlKTtcbiAgICAgICAgcmV0dXJuIGZpcnN0UGllY2VGb3JtYXQuc3Vic3RyaW5nKDAsIDEpID09PSBjaGFyXG4gICAgICAgICAgICA/IHBpZWNlc1swXVxuICAgICAgICAgICAgOiBwaWVjZXNbMV07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZXNvbHZlQnlSb3cocGllY2VzOiBQaWVjZVtdLCBjaGFyOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IGZpcnN0UGllY2VGb3JtYXQgPSBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKHBpZWNlc1swXS5wb2ludCwgZmFsc2UpO1xuICAgICAgICBsZXQgc2Vjb25kUGllY2VGb3JtYXQgPSBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKHBpZWNlc1sxXS5wb2ludCwgZmFsc2UpO1xuICAgICAgICByZXR1cm4gZmlyc3RQaWVjZUZvcm1hdC5zdWJzdHJpbmcoMSwgMikgPT09IGNoYXJcbiAgICAgICAgICAgID8gcGllY2VzWzBdXG4gICAgICAgICAgICA6IHBpZWNlc1sxXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlcGxhY2VQcm9tb3Rpb24obW92ZTogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBtb3ZlXG4gICAgICAgICAgICAucmVwbGFjZSgnPVEnLCAnMScpXG4gICAgICAgICAgICAucmVwbGFjZSgnPVInLCAnMicpXG4gICAgICAgICAgICAucmVwbGFjZSgnPUInLCAnMycpXG4gICAgICAgICAgICAucmVwbGFjZSgnPUsnLCAnNCcpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVzb2x2ZVByb21vdGlvbihwcm9tb3Rpb25DaGFyOiBzdHJpbmcpIHtcbiAgICAgICAgc3dpdGNoIChwcm9tb3Rpb25DaGFyKSB7XG4gICAgICAgICAgICBjYXNlICdRJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gJzEnO1xuICAgICAgICAgICAgY2FzZSAnUic6XG4gICAgICAgICAgICAgICAgcmV0dXJuICcyJztcbiAgICAgICAgICAgIGNhc2UgJ0InOlxuICAgICAgICAgICAgICAgIHJldHVybiAnMyc7XG4gICAgICAgICAgICBjYXNlICdOJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gJzQnO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAnJztcbiAgICB9XG59XG4iXX0=