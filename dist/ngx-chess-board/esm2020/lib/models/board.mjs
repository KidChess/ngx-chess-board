import { cloneDeep } from 'lodash';
import { Bishop } from './pieces/bishop';
import { Coin } from './pieces/coin';
import { Color } from './pieces/color';
import { King } from './pieces/king';
import { Knight } from './pieces/knight';
import { Pawn } from './pieces/pawn';
import { Point } from './pieces/point';
import { Queen } from './pieces/queen';
import { Rook } from './pieces/rook';
export class Board {
    constructor() {
        this.board = [];
        this.pieces = [];
        this.enPassantPoint = null;
        this.enPassantPiece = null;
        this.lastMoveSrc = null;
        this.lastMoveDest = null;
        this.possibleCaptures = [];
        this.possibleMoves = [];
        this.currentWhitePlayer = true;
        this.reverted = false;
        this.fullMoveCount = 1;
        for (let i = 0; i < 8; ++i) {
            this.board[i] = [];
            for (let j = 0; j < 8; ++j) {
                this.board[i][j] = 0;
            }
        }
    }
    isXYInPossibleMoves(row, col) {
        return this.possibleMoves.some((move) => move.row === row && move.col === col);
    }
    isXYInPossibleCaptures(row, col) {
        return this.possibleCaptures.some((capture) => capture.row === row && capture.col === col);
    }
    isXYInSourceMove(i, j) {
        return (this.lastMoveSrc &&
            this.lastMoveSrc.row === i &&
            this.lastMoveSrc.col === j);
    }
    isXYInDestMove(i, j) {
        return (this.lastMoveDest &&
            this.lastMoveDest.row === i &&
            this.lastMoveDest.col === j);
    }
    isXYInActiveMove(i, j) {
        return (this.activePiece &&
            this.activePiece.point.row === i &&
            this.activePiece.point.col === j);
    }
    isPointInPossibleMoves(point) {
        return this.possibleMoves.some((move) => move.row === point.row && move.col === point.col);
    }
    isPointInPossibleCaptures(point) {
        return this.possibleCaptures.some((capture) => capture.row === point.row && capture.col === point.col);
    }
    reset() {
        this.lastMoveDest = null;
        this.lastMoveSrc = null;
        this.whiteKingChecked = false;
        this.blackKingChecked = false;
        this.possibleCaptures = [];
        this.possibleMoves = [];
        this.activePiece = null;
        this.reverted = false;
        this.currentWhitePlayer = true;
        this.enPassantPoint = null;
        this.enPassantPiece = null;
        this.fullMoveCount = 1;
        this.calculateFEN();
    }
    reverse() {
        this.reverted = !this.reverted;
        this.activePiece = null;
        this.possibleMoves = [];
        this.possibleCaptures = [];
        this.pieces.forEach((piece) => this.reversePoint(piece.point));
        this.reversePoint(this.lastMoveSrc);
        this.reversePoint(this.lastMoveDest);
        if (this.enPassantPoint && this.enPassantPiece) {
            this.reversePoint(this.enPassantPoint);
        }
    }
    clone() {
        return cloneDeep(this);
    }
    isFieldTakenByEnemy(row, col, enemyColor) {
        if (row > 7 || row < 0 || col > 7 || col < 0) {
            return false;
        }
        return this.pieces.some((piece) => piece.point.col === col &&
            piece.point.row === row &&
            piece.color === enemyColor);
    }
    isFieldEmpty(row, col) {
        if (row > 7 || row < 0 || col > 7 || col < 0) {
            return false;
        }
        return !this.pieces.some((piece) => piece.point.col === col && piece.point.row === row);
    }
    isFieldUnderAttack(row, col, color) {
        return this.pieces
            .filter((piece) => piece.color === color)
            .some((piece) => piece
            .getCoveredFields()
            .some((field) => field.col === col && field.row === row));
    }
    getPieceByField(row, col) {
        if (this.isFieldEmpty(row, col)) {
            //   throw new Error('Piece not found');
            return undefined;
        }
        return this.pieces.find((piece) => piece.point.col === col && piece.point.row === row);
    }
    isKingInCheck(color, pieces) {
        const king = pieces.find((piece) => piece.color === color && piece instanceof King);
        if (king) {
            return pieces.some((piece) => piece
                .getPossibleCaptures()
                .some((point) => point.col === king.point.col &&
                point.row === king.point.row) && piece.color !== color);
        }
        return false;
    }
    getKingByColor(color) {
        return this.pieces.find((piece) => piece instanceof King && piece.color === color);
    }
    getCastleFENString(color) {
        const king = this.getKingByColor(color);
        if (!king || king.isMovedAlready) {
            return '';
        }
        let fen = '';
        const leftRook = this.getPieceByField(king.point.row, 0);
        const rightRook = this.getPieceByField(king.point.row, 7);
        if (rightRook instanceof Rook && rightRook.color === color) {
            if (!rightRook.isMovedAlready) {
                fen += this.reverted ? 'q' : 'k';
            }
        }
        if (leftRook instanceof Rook && leftRook.color === color) {
            if (!leftRook.isMovedAlready) {
                fen += this.reverted ? 'k' : 'q';
            }
        }
        fen = fen.split('').sort().join('');
        return color === Color.BLACK ? fen : fen.toUpperCase();
    }
    getEnPassantFENString() {
        if (this.enPassantPoint) {
            if (this.reverted) {
                return (String.fromCharCode(104 - this.enPassantPoint.col) +
                    (this.enPassantPoint.row + 1));
            }
            else {
                return (String.fromCharCode(97 + this.enPassantPoint.col) +
                    (Math.abs(this.enPassantPoint.row - 7) + 1));
            }
        }
        else {
            return '-';
        }
    }
    calculateFEN() {
        let fen = '';
        for (let i = 0; i < 8; ++i) {
            let emptyFields = 0;
            for (let j = 0; j < 8; ++j) {
                const foundPiece = this.pieces.find((piece) => piece.point.col === j && piece.point.row === i);
                if (foundPiece) {
                    if (emptyFields > 0) {
                        fen += emptyFields;
                        emptyFields = 0;
                    }
                    if (foundPiece instanceof Rook) {
                        fen += foundPiece.color === Color.BLACK ? 'r' : 'R';
                    }
                    else {
                        if (foundPiece instanceof Knight) {
                            fen += foundPiece.color === Color.BLACK ? 'n' : 'N';
                        }
                        else {
                            if (foundPiece instanceof Bishop) {
                                fen +=
                                    foundPiece.color === Color.BLACK
                                        ? 'b'
                                        : 'B';
                            }
                            else {
                                if (foundPiece instanceof Queen) {
                                    fen +=
                                        foundPiece.color === Color.BLACK
                                            ? 'q'
                                            : 'Q';
                                }
                                else {
                                    if (foundPiece instanceof King) {
                                        fen +=
                                            foundPiece.color === Color.BLACK
                                                ? 'k'
                                                : 'K';
                                    }
                                    else {
                                        if (foundPiece instanceof Pawn) {
                                            fen +=
                                                foundPiece.color === Color.BLACK
                                                    ? 'p'
                                                    : 'P';
                                        }
                                        else {
                                            if (foundPiece instanceof Coin) {
                                                fen +=
                                                    foundPiece.color ===
                                                        Color.BLACK
                                                        ? 'c'
                                                        : 'C';
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                else {
                    ++emptyFields;
                }
            }
            if (emptyFields > 0) {
                fen += emptyFields;
            }
            fen += '/';
        }
        fen = fen.substr(0, fen.length - 1);
        if (this.reverted) {
            fen = fen.split('').reverse().join('');
        }
        fen += ' ' + (this.currentWhitePlayer ? 'w' : 'b');
        const whiteEnPassant = this.getCastleFENString(Color.WHITE);
        const blackEnPassant = this.getCastleFENString(Color.BLACK);
        let concatedEnPassant = whiteEnPassant + blackEnPassant;
        if (!concatedEnPassant) {
            concatedEnPassant = '-';
        }
        fen += ' ' + concatedEnPassant;
        fen += ' ' + this.getEnPassantFENString();
        fen += ' ' + 0;
        fen += ' ' + this.fullMoveCount;
        this.fen = fen;
    }
    isXYInPointSelection(i, j) {
        return false;
    }
    reversePoint(point) {
        if (point) {
            point.row = Math.abs(point.row - 7);
            point.col = Math.abs(point.col - 7);
        }
    }
    getPieceByPoint(row, col) {
        row = Math.floor(row);
        col = Math.floor(col);
        return this.pieces.find((piece) => piece.point.col === col && piece.point.row === row);
    }
    checkIfPawnTakesEnPassant(newPoint) {
        if (newPoint.isEqual(this.enPassantPoint)) {
            this.pieces = this.pieces.filter((piece) => piece !== this.enPassantPiece);
            this.enPassantPoint = null;
            this.enPassantPiece = null;
        }
    }
    checkIfPawnEnpassanted(piece, newPoint) {
        if (Math.abs(piece.point.row - newPoint.row) > 1) {
            this.enPassantPiece = piece;
            this.enPassantPoint = new Point((piece.point.row + newPoint.row) / 2, piece.point.col);
        }
        else {
            this.enPassantPoint = null;
            this.enPassantPiece = null;
        }
    }
    isKingChecked(piece) {
        if (piece instanceof King) {
            return piece.color === Color.WHITE
                ? this.whiteKingChecked
                : this.blackKingChecked;
        }
    }
    getCurrentPlayerColor() {
        return this.currentWhitePlayer ? Color.WHITE : Color.BLACK;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9hcmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtY2hlc3MtYm9hcmQvc3JjL2xpYi9tb2RlbHMvYm9hcmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUNuQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVyQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFckMsTUFBTSxPQUFPLEtBQUs7SUFvQmQ7UUFuQkEsVUFBSyxHQUFlLEVBQUUsQ0FBQztRQUN2QixXQUFNLEdBQVksRUFBRSxDQUFDO1FBRXJCLG1CQUFjLEdBQVUsSUFBSSxDQUFDO1FBQzdCLG1CQUFjLEdBQVUsSUFBSSxDQUFDO1FBQzdCLGdCQUFXLEdBQVUsSUFBSSxDQUFDO1FBQzFCLGlCQUFZLEdBQVUsSUFBSSxDQUFDO1FBSTNCLHFCQUFnQixHQUFVLEVBQUUsQ0FBQztRQUM3QixrQkFBYSxHQUFZLEVBQUUsQ0FBQztRQUc1Qix1QkFBa0IsR0FBRyxJQUFJLENBQUM7UUFDMUIsYUFBUSxHQUFHLEtBQUssQ0FBQztRQUNqQixrQkFBYSxHQUFHLENBQUMsQ0FBQztRQUlkLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUU7WUFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDbkIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRTtnQkFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDeEI7U0FDSjtJQUNMLENBQUM7SUFFRCxtQkFBbUIsQ0FBQyxHQUFXLEVBQUUsR0FBVztRQUN4QyxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUMxQixDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxHQUFHLElBQUksSUFBSSxDQUFDLEdBQUcsS0FBSyxHQUFHLENBQ2pELENBQUM7SUFDTixDQUFDO0lBRUQsc0JBQXNCLENBQUMsR0FBVyxFQUFFLEdBQVc7UUFDM0MsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUM3QixDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsS0FBSyxHQUFHLElBQUksT0FBTyxDQUFDLEdBQUcsS0FBSyxHQUFHLENBQzFELENBQUM7SUFDTixDQUFDO0lBRUQsZ0JBQWdCLENBQUMsQ0FBUyxFQUFFLENBQVM7UUFDakMsT0FBTyxDQUNILElBQUksQ0FBQyxXQUFXO1lBQ2hCLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxLQUFLLENBQUM7WUFDMUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUM3QixDQUFDO0lBQ04sQ0FBQztJQUVELGNBQWMsQ0FBQyxDQUFTLEVBQUUsQ0FBUztRQUMvQixPQUFPLENBQ0gsSUFBSSxDQUFDLFlBQVk7WUFDakIsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLEtBQUssQ0FBQztZQUMzQixJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQzlCLENBQUM7SUFDTixDQUFDO0lBRUQsZ0JBQWdCLENBQUMsQ0FBUyxFQUFFLENBQVM7UUFDakMsT0FBTyxDQUNILElBQUksQ0FBQyxXQUFXO1lBQ2hCLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsS0FBSyxDQUFDO1lBQ2hDLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQ25DLENBQUM7SUFDTixDQUFDO0lBRUQsc0JBQXNCLENBQUMsS0FBWTtRQUMvQixPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUMxQixDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxLQUFLLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLEtBQUssS0FBSyxDQUFDLEdBQUcsQ0FDN0QsQ0FBQztJQUNOLENBQUM7SUFFRCx5QkFBeUIsQ0FBQyxLQUFZO1FBQ2xDLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FDN0IsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEtBQUssS0FBSyxDQUFDLEdBQUcsSUFBSSxPQUFPLENBQUMsR0FBRyxLQUFLLEtBQUssQ0FBQyxHQUFHLENBQ3RFLENBQUM7SUFDTixDQUFDO0lBRUQsS0FBSztRQUNELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxLQUFLLENBQUM7UUFDOUIsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQztRQUM5QixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUM7UUFDL0IsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUM7UUFDM0IsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUM7UUFDM0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUM7UUFDdkIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFFRCxPQUFPO1FBQ0gsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDL0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEVBQUUsQ0FBQztRQUUzQixJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQVksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUV0RSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNwQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUVyQyxJQUFJLElBQUksQ0FBQyxjQUFjLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUM1QyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztTQUMxQztJQUNMLENBQUM7SUFFRCxLQUFLO1FBQ0QsT0FBTyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0IsQ0FBQztJQUVELG1CQUFtQixDQUFDLEdBQVcsRUFBRSxHQUFXLEVBQUUsVUFBaUI7UUFDM0QsSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFO1lBQzFDLE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBQ0QsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDbkIsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUNOLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxLQUFLLEdBQUc7WUFDdkIsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLEtBQUssR0FBRztZQUN2QixLQUFLLENBQUMsS0FBSyxLQUFLLFVBQVUsQ0FDakMsQ0FBQztJQUNOLENBQUM7SUFFRCxZQUFZLENBQUMsR0FBVyxFQUFFLEdBQVc7UUFDakMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFO1lBQzFDLE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBQ0QsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNwQixDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxLQUFLLEdBQUcsQ0FDaEUsQ0FBQztJQUNOLENBQUM7SUFFRCxrQkFBa0IsQ0FBQyxHQUFXLEVBQUUsR0FBVyxFQUFFLEtBQVk7UUFDckQsT0FBTyxJQUFJLENBQUMsTUFBTTthQUNiLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssS0FBSyxLQUFLLENBQUM7YUFDeEMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FDWixLQUFLO2FBQ0EsZ0JBQWdCLEVBQUU7YUFDbEIsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsR0FBRyxLQUFLLEdBQUcsQ0FBQyxDQUMvRCxDQUFDO0lBQ1YsQ0FBQztJQUVELGVBQWUsQ0FBQyxHQUFXLEVBQUUsR0FBVztRQUNwQyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxFQUFFO1lBQzdCLHdDQUF3QztZQUN4QyxPQUFPLFNBQVMsQ0FBQztTQUNwQjtRQUVELE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQ25CLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLEtBQUssR0FBRyxDQUNoRSxDQUFDO0lBQ04sQ0FBQztJQUVELGFBQWEsQ0FBQyxLQUFZLEVBQUUsTUFBZTtRQUN2QyxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUNwQixDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssS0FBSyxLQUFLLElBQUksS0FBSyxZQUFZLElBQUksQ0FDNUQsQ0FBQztRQUVGLElBQUksSUFBSSxFQUFFO1lBQ04sT0FBTyxNQUFNLENBQUMsSUFBSSxDQUNkLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FDTixLQUFLO2lCQUNBLG1CQUFtQixFQUFFO2lCQUNyQixJQUFJLENBQ0QsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUNOLEtBQUssQ0FBQyxHQUFHLEtBQUssSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHO2dCQUM1QixLQUFLLENBQUMsR0FBRyxLQUFLLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUNuQyxJQUFJLEtBQUssQ0FBQyxLQUFLLEtBQUssS0FBSyxDQUNyQyxDQUFDO1NBQ0w7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRUQsY0FBYyxDQUFDLEtBQVk7UUFDdkIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDbkIsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssWUFBWSxJQUFJLElBQUksS0FBSyxDQUFDLEtBQUssS0FBSyxLQUFLLENBQ3BELENBQUM7SUFDZCxDQUFDO0lBRUQsa0JBQWtCLENBQUMsS0FBWTtRQUMzQixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXhDLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUM5QixPQUFPLEVBQUUsQ0FBQztTQUNiO1FBRUQsSUFBSSxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ2IsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN6RCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRTFELElBQUksU0FBUyxZQUFZLElBQUksSUFBSSxTQUFTLENBQUMsS0FBSyxLQUFLLEtBQUssRUFBRTtZQUN4RCxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsRUFBRTtnQkFDM0IsR0FBRyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO2FBQ3BDO1NBQ0o7UUFFRCxJQUFJLFFBQVEsWUFBWSxJQUFJLElBQUksUUFBUSxDQUFDLEtBQUssS0FBSyxLQUFLLEVBQUU7WUFDdEQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLEVBQUU7Z0JBQzFCLEdBQUcsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQzthQUNwQztTQUNKO1FBRUQsR0FBRyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3BDLE9BQU8sS0FBSyxLQUFLLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQzNELENBQUM7SUFFRCxxQkFBcUI7UUFDakIsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ3JCLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDZixPQUFPLENBQ0gsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUM7b0JBQ2xELENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQ2hDLENBQUM7YUFDTDtpQkFBTTtnQkFDSCxPQUFPLENBQ0gsTUFBTSxDQUFDLFlBQVksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUM7b0JBQ2pELENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDOUMsQ0FBQzthQUNMO1NBQ0o7YUFBTTtZQUNILE9BQU8sR0FBRyxDQUFDO1NBQ2Q7SUFDTCxDQUFDO0lBRUQsWUFBWTtRQUNSLElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQztRQUNiLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUU7WUFDeEIsSUFBSSxXQUFXLEdBQUcsQ0FBQyxDQUFDO1lBQ3BCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUU7Z0JBQ3hCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUMvQixDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FDNUQsQ0FBQztnQkFDRixJQUFJLFVBQVUsRUFBRTtvQkFDWixJQUFJLFdBQVcsR0FBRyxDQUFDLEVBQUU7d0JBQ2pCLEdBQUcsSUFBSSxXQUFXLENBQUM7d0JBQ25CLFdBQVcsR0FBRyxDQUFDLENBQUM7cUJBQ25CO29CQUVELElBQUksVUFBVSxZQUFZLElBQUksRUFBRTt3QkFDNUIsR0FBRyxJQUFJLFVBQVUsQ0FBQyxLQUFLLEtBQUssS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7cUJBQ3ZEO3lCQUFNO3dCQUNILElBQUksVUFBVSxZQUFZLE1BQU0sRUFBRTs0QkFDOUIsR0FBRyxJQUFJLFVBQVUsQ0FBQyxLQUFLLEtBQUssS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7eUJBQ3ZEOzZCQUFNOzRCQUNILElBQUksVUFBVSxZQUFZLE1BQU0sRUFBRTtnQ0FDOUIsR0FBRztvQ0FDQyxVQUFVLENBQUMsS0FBSyxLQUFLLEtBQUssQ0FBQyxLQUFLO3dDQUM1QixDQUFDLENBQUMsR0FBRzt3Q0FDTCxDQUFDLENBQUMsR0FBRyxDQUFDOzZCQUNqQjtpQ0FBTTtnQ0FDSCxJQUFJLFVBQVUsWUFBWSxLQUFLLEVBQUU7b0NBQzdCLEdBQUc7d0NBQ0MsVUFBVSxDQUFDLEtBQUssS0FBSyxLQUFLLENBQUMsS0FBSzs0Q0FDNUIsQ0FBQyxDQUFDLEdBQUc7NENBQ0wsQ0FBQyxDQUFDLEdBQUcsQ0FBQztpQ0FDakI7cUNBQU07b0NBQ0gsSUFBSSxVQUFVLFlBQVksSUFBSSxFQUFFO3dDQUM1QixHQUFHOzRDQUNDLFVBQVUsQ0FBQyxLQUFLLEtBQUssS0FBSyxDQUFDLEtBQUs7Z0RBQzVCLENBQUMsQ0FBQyxHQUFHO2dEQUNMLENBQUMsQ0FBQyxHQUFHLENBQUM7cUNBQ2pCO3lDQUFNO3dDQUNILElBQUksVUFBVSxZQUFZLElBQUksRUFBRTs0Q0FDNUIsR0FBRztnREFDQyxVQUFVLENBQUMsS0FBSyxLQUFLLEtBQUssQ0FBQyxLQUFLO29EQUM1QixDQUFDLENBQUMsR0FBRztvREFDTCxDQUFDLENBQUMsR0FBRyxDQUFDO3lDQUNqQjs2Q0FBTTs0Q0FDSCxJQUFJLFVBQVUsWUFBWSxJQUFJLEVBQUU7Z0RBQzVCLEdBQUc7b0RBQ0MsVUFBVSxDQUFDLEtBQUs7d0RBQ2hCLEtBQUssQ0FBQyxLQUFLO3dEQUNQLENBQUMsQ0FBQyxHQUFHO3dEQUNMLENBQUMsQ0FBQyxHQUFHLENBQUM7NkNBQ2pCO3lDQUNKO3FDQUNKO2lDQUNKOzZCQUNKO3lCQUNKO3FCQUNKO2lCQUNKO3FCQUFNO29CQUNILEVBQUUsV0FBVyxDQUFDO2lCQUNqQjthQUNKO1lBRUQsSUFBSSxXQUFXLEdBQUcsQ0FBQyxFQUFFO2dCQUNqQixHQUFHLElBQUksV0FBVyxDQUFDO2FBQ3RCO1lBRUQsR0FBRyxJQUFJLEdBQUcsQ0FBQztTQUNkO1FBRUQsR0FBRyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFcEMsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2YsR0FBRyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQzFDO1FBRUQsR0FBRyxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNuRCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzVELE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDNUQsSUFBSSxpQkFBaUIsR0FBRyxjQUFjLEdBQUcsY0FBYyxDQUFDO1FBQ3hELElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUNwQixpQkFBaUIsR0FBRyxHQUFHLENBQUM7U0FDM0I7UUFFRCxHQUFHLElBQUksR0FBRyxHQUFHLGlCQUFpQixDQUFDO1FBQy9CLEdBQUcsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFDMUMsR0FBRyxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDZixHQUFHLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUM7UUFDaEMsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7SUFDbkIsQ0FBQztJQUVELG9CQUFvQixDQUFDLENBQVMsRUFBRSxDQUFTO1FBQ3JDLE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFFTyxZQUFZLENBQUMsS0FBWTtRQUM3QixJQUFJLEtBQUssRUFBRTtZQUNQLEtBQUssQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLEtBQUssQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQ3ZDO0lBQ0wsQ0FBQztJQUVNLGVBQWUsQ0FBQyxHQUFXLEVBQUUsR0FBVztRQUMzQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN0QixHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN0QixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNuQixDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxLQUFLLEdBQUcsQ0FDaEUsQ0FBQztJQUNOLENBQUM7SUFFTSx5QkFBeUIsQ0FBQyxRQUFlO1FBQzVDLElBQUksUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEVBQUU7WUFDdkMsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FDNUIsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssS0FBSyxJQUFJLENBQUMsY0FBYyxDQUMzQyxDQUFDO1lBQ0YsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUM7WUFDM0IsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUM7U0FDOUI7SUFDTCxDQUFDO0lBRU0sc0JBQXNCLENBQUMsS0FBVyxFQUFFLFFBQWU7UUFDdEQsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDOUMsSUFBSSxDQUFDLGNBQWMsR0FBRyxLQUFLLENBQUM7WUFDNUIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLEtBQUssQ0FDM0IsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUNwQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FDbEIsQ0FBQztTQUNMO2FBQU07WUFDSCxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQztZQUMzQixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQztTQUM5QjtJQUNMLENBQUM7SUFFRCxhQUFhLENBQUMsS0FBWTtRQUN0QixJQUFJLEtBQUssWUFBWSxJQUFJLEVBQUU7WUFDdkIsT0FBTyxLQUFLLENBQUMsS0FBSyxLQUFLLEtBQUssQ0FBQyxLQUFLO2dCQUM5QixDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQjtnQkFDdkIsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztTQUMvQjtJQUNMLENBQUM7SUFFRCxxQkFBcUI7UUFDakIsT0FBTyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7SUFDL0QsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY2xvbmVEZWVwIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IEJpc2hvcCB9IGZyb20gJy4vcGllY2VzL2Jpc2hvcCc7XG5pbXBvcnQgeyBDb2luIH0gZnJvbSAnLi9waWVjZXMvY29pbic7XG5pbXBvcnQgeyBDb2xvciB9IGZyb20gJy4vcGllY2VzL2NvbG9yJztcbmltcG9ydCB7IEtpbmcgfSBmcm9tICcuL3BpZWNlcy9raW5nJztcbmltcG9ydCB7IEtuaWdodCB9IGZyb20gJy4vcGllY2VzL2tuaWdodCc7XG5pbXBvcnQgeyBQYXduIH0gZnJvbSAnLi9waWVjZXMvcGF3bic7XG5pbXBvcnQgeyBQaWVjZSB9IGZyb20gJy4vcGllY2VzL3BpZWNlJztcbmltcG9ydCB7IFBvaW50IH0gZnJvbSAnLi9waWVjZXMvcG9pbnQnO1xuaW1wb3J0IHsgUXVlZW4gfSBmcm9tICcuL3BpZWNlcy9xdWVlbic7XG5pbXBvcnQgeyBSb29rIH0gZnJvbSAnLi9waWVjZXMvcm9vayc7XG5cbmV4cG9ydCBjbGFzcyBCb2FyZCB7XG4gICAgYm9hcmQ6IG51bWJlcltdW10gPSBbXTtcbiAgICBwaWVjZXM6IFBpZWNlW10gPSBbXTtcblxuICAgIGVuUGFzc2FudFBvaW50OiBQb2ludCA9IG51bGw7XG4gICAgZW5QYXNzYW50UGllY2U6IFBpZWNlID0gbnVsbDtcbiAgICBsYXN0TW92ZVNyYzogUG9pbnQgPSBudWxsO1xuICAgIGxhc3RNb3ZlRGVzdDogUG9pbnQgPSBudWxsO1xuICAgIGFjdGl2ZVBpZWNlOiBQaWVjZTtcblxuICAgIGJsYWNrS2luZ0NoZWNrZWQ6IGJvb2xlYW47XG4gICAgcG9zc2libGVDYXB0dXJlczogYW55W10gPSBbXTtcbiAgICBwb3NzaWJsZU1vdmVzOiBQb2ludFtdID0gW107XG4gICAgd2hpdGVLaW5nQ2hlY2tlZDogYm9vbGVhbjtcblxuICAgIGN1cnJlbnRXaGl0ZVBsYXllciA9IHRydWU7XG4gICAgcmV2ZXJ0ZWQgPSBmYWxzZTtcbiAgICBmdWxsTW92ZUNvdW50ID0gMTtcbiAgICBmZW46IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDg7ICsraSkge1xuICAgICAgICAgICAgdGhpcy5ib2FyZFtpXSA9IFtdO1xuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCA4OyArK2opIHtcbiAgICAgICAgICAgICAgICB0aGlzLmJvYXJkW2ldW2pdID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlzWFlJblBvc3NpYmxlTW92ZXMocm93OiBudW1iZXIsIGNvbDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLnBvc3NpYmxlTW92ZXMuc29tZShcbiAgICAgICAgICAgIChtb3ZlKSA9PiBtb3ZlLnJvdyA9PT0gcm93ICYmIG1vdmUuY29sID09PSBjb2wsXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgaXNYWUluUG9zc2libGVDYXB0dXJlcyhyb3c6IG51bWJlciwgY29sOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucG9zc2libGVDYXB0dXJlcy5zb21lKFxuICAgICAgICAgICAgKGNhcHR1cmUpID0+IGNhcHR1cmUucm93ID09PSByb3cgJiYgY2FwdHVyZS5jb2wgPT09IGNvbCxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBpc1hZSW5Tb3VyY2VNb3ZlKGk6IG51bWJlciwgajogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICB0aGlzLmxhc3RNb3ZlU3JjICYmXG4gICAgICAgICAgICB0aGlzLmxhc3RNb3ZlU3JjLnJvdyA9PT0gaSAmJlxuICAgICAgICAgICAgdGhpcy5sYXN0TW92ZVNyYy5jb2wgPT09IGpcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBpc1hZSW5EZXN0TW92ZShpOiBudW1iZXIsIGo6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgdGhpcy5sYXN0TW92ZURlc3QgJiZcbiAgICAgICAgICAgIHRoaXMubGFzdE1vdmVEZXN0LnJvdyA9PT0gaSAmJlxuICAgICAgICAgICAgdGhpcy5sYXN0TW92ZURlc3QuY29sID09PSBqXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgaXNYWUluQWN0aXZlTW92ZShpOiBudW1iZXIsIGo6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgdGhpcy5hY3RpdmVQaWVjZSAmJlxuICAgICAgICAgICAgdGhpcy5hY3RpdmVQaWVjZS5wb2ludC5yb3cgPT09IGkgJiZcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlUGllY2UucG9pbnQuY29sID09PSBqXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgaXNQb2ludEluUG9zc2libGVNb3Zlcyhwb2ludDogUG9pbnQpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucG9zc2libGVNb3Zlcy5zb21lKFxuICAgICAgICAgICAgKG1vdmUpID0+IG1vdmUucm93ID09PSBwb2ludC5yb3cgJiYgbW92ZS5jb2wgPT09IHBvaW50LmNvbCxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBpc1BvaW50SW5Qb3NzaWJsZUNhcHR1cmVzKHBvaW50OiBQb2ludCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wb3NzaWJsZUNhcHR1cmVzLnNvbWUoXG4gICAgICAgICAgICAoY2FwdHVyZSkgPT4gY2FwdHVyZS5yb3cgPT09IHBvaW50LnJvdyAmJiBjYXB0dXJlLmNvbCA9PT0gcG9pbnQuY29sLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIHJlc2V0KCkge1xuICAgICAgICB0aGlzLmxhc3RNb3ZlRGVzdCA9IG51bGw7XG4gICAgICAgIHRoaXMubGFzdE1vdmVTcmMgPSBudWxsO1xuICAgICAgICB0aGlzLndoaXRlS2luZ0NoZWNrZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5ibGFja0tpbmdDaGVja2VkID0gZmFsc2U7XG4gICAgICAgIHRoaXMucG9zc2libGVDYXB0dXJlcyA9IFtdO1xuICAgICAgICB0aGlzLnBvc3NpYmxlTW92ZXMgPSBbXTtcbiAgICAgICAgdGhpcy5hY3RpdmVQaWVjZSA9IG51bGw7XG4gICAgICAgIHRoaXMucmV2ZXJ0ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5jdXJyZW50V2hpdGVQbGF5ZXIgPSB0cnVlO1xuICAgICAgICB0aGlzLmVuUGFzc2FudFBvaW50ID0gbnVsbDtcbiAgICAgICAgdGhpcy5lblBhc3NhbnRQaWVjZSA9IG51bGw7XG4gICAgICAgIHRoaXMuZnVsbE1vdmVDb3VudCA9IDE7XG4gICAgICAgIHRoaXMuY2FsY3VsYXRlRkVOKCk7XG4gICAgfVxuXG4gICAgcmV2ZXJzZSgpIHtcbiAgICAgICAgdGhpcy5yZXZlcnRlZCA9ICF0aGlzLnJldmVydGVkO1xuICAgICAgICB0aGlzLmFjdGl2ZVBpZWNlID0gbnVsbDtcbiAgICAgICAgdGhpcy5wb3NzaWJsZU1vdmVzID0gW107XG4gICAgICAgIHRoaXMucG9zc2libGVDYXB0dXJlcyA9IFtdO1xuXG4gICAgICAgIHRoaXMucGllY2VzLmZvckVhY2goKHBpZWNlOiBQaWVjZSkgPT4gdGhpcy5yZXZlcnNlUG9pbnQocGllY2UucG9pbnQpKTtcblxuICAgICAgICB0aGlzLnJldmVyc2VQb2ludCh0aGlzLmxhc3RNb3ZlU3JjKTtcbiAgICAgICAgdGhpcy5yZXZlcnNlUG9pbnQodGhpcy5sYXN0TW92ZURlc3QpO1xuXG4gICAgICAgIGlmICh0aGlzLmVuUGFzc2FudFBvaW50ICYmIHRoaXMuZW5QYXNzYW50UGllY2UpIHtcbiAgICAgICAgICAgIHRoaXMucmV2ZXJzZVBvaW50KHRoaXMuZW5QYXNzYW50UG9pbnQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY2xvbmUoKTogQm9hcmQge1xuICAgICAgICByZXR1cm4gY2xvbmVEZWVwKHRoaXMpO1xuICAgIH1cblxuICAgIGlzRmllbGRUYWtlbkJ5RW5lbXkocm93OiBudW1iZXIsIGNvbDogbnVtYmVyLCBlbmVteUNvbG9yOiBDb2xvcik6IGJvb2xlYW4ge1xuICAgICAgICBpZiAocm93ID4gNyB8fCByb3cgPCAwIHx8IGNvbCA+IDcgfHwgY29sIDwgMCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnBpZWNlcy5zb21lKFxuICAgICAgICAgICAgKHBpZWNlKSA9PlxuICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LmNvbCA9PT0gY29sICYmXG4gICAgICAgICAgICAgICAgcGllY2UucG9pbnQucm93ID09PSByb3cgJiZcbiAgICAgICAgICAgICAgICBwaWVjZS5jb2xvciA9PT0gZW5lbXlDb2xvcixcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBpc0ZpZWxkRW1wdHkocm93OiBudW1iZXIsIGNvbDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgICAgIGlmIChyb3cgPiA3IHx8IHJvdyA8IDAgfHwgY29sID4gNyB8fCBjb2wgPCAwKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICF0aGlzLnBpZWNlcy5zb21lKFxuICAgICAgICAgICAgKHBpZWNlKSA9PiBwaWVjZS5wb2ludC5jb2wgPT09IGNvbCAmJiBwaWVjZS5wb2ludC5yb3cgPT09IHJvdyxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBpc0ZpZWxkVW5kZXJBdHRhY2socm93OiBudW1iZXIsIGNvbDogbnVtYmVyLCBjb2xvcjogQ29sb3IpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGllY2VzXG4gICAgICAgICAgICAuZmlsdGVyKChwaWVjZSkgPT4gcGllY2UuY29sb3IgPT09IGNvbG9yKVxuICAgICAgICAgICAgLnNvbWUoKHBpZWNlKSA9PlxuICAgICAgICAgICAgICAgIHBpZWNlXG4gICAgICAgICAgICAgICAgICAgIC5nZXRDb3ZlcmVkRmllbGRzKClcbiAgICAgICAgICAgICAgICAgICAgLnNvbWUoKGZpZWxkKSA9PiBmaWVsZC5jb2wgPT09IGNvbCAmJiBmaWVsZC5yb3cgPT09IHJvdyksXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIGdldFBpZWNlQnlGaWVsZChyb3c6IG51bWJlciwgY29sOiBudW1iZXIpOiBQaWVjZSB7XG4gICAgICAgIGlmICh0aGlzLmlzRmllbGRFbXB0eShyb3csIGNvbCkpIHtcbiAgICAgICAgICAgIC8vICAgdGhyb3cgbmV3IEVycm9yKCdQaWVjZSBub3QgZm91bmQnKTtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5waWVjZXMuZmluZChcbiAgICAgICAgICAgIChwaWVjZSkgPT4gcGllY2UucG9pbnQuY29sID09PSBjb2wgJiYgcGllY2UucG9pbnQucm93ID09PSByb3csXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgaXNLaW5nSW5DaGVjayhjb2xvcjogQ29sb3IsIHBpZWNlczogUGllY2VbXSk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBraW5nID0gcGllY2VzLmZpbmQoXG4gICAgICAgICAgICAocGllY2UpID0+IHBpZWNlLmNvbG9yID09PSBjb2xvciAmJiBwaWVjZSBpbnN0YW5jZW9mIEtpbmcsXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGtpbmcpIHtcbiAgICAgICAgICAgIHJldHVybiBwaWVjZXMuc29tZShcbiAgICAgICAgICAgICAgICAocGllY2UpID0+XG4gICAgICAgICAgICAgICAgICAgIHBpZWNlXG4gICAgICAgICAgICAgICAgICAgICAgICAuZ2V0UG9zc2libGVDYXB0dXJlcygpXG4gICAgICAgICAgICAgICAgICAgICAgICAuc29tZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAocG9pbnQpID0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50LmNvbCA9PT0ga2luZy5wb2ludC5jb2wgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnQucm93ID09PSBraW5nLnBvaW50LnJvdyxcbiAgICAgICAgICAgICAgICAgICAgICAgICkgJiYgcGllY2UuY29sb3IgIT09IGNvbG9yLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgZ2V0S2luZ0J5Q29sb3IoY29sb3I6IENvbG9yKTogS2luZyB7XG4gICAgICAgIHJldHVybiB0aGlzLnBpZWNlcy5maW5kKFxuICAgICAgICAgICAgKHBpZWNlKSA9PiBwaWVjZSBpbnN0YW5jZW9mIEtpbmcgJiYgcGllY2UuY29sb3IgPT09IGNvbG9yLFxuICAgICAgICApIGFzIEtpbmc7XG4gICAgfVxuXG4gICAgZ2V0Q2FzdGxlRkVOU3RyaW5nKGNvbG9yOiBDb2xvcikge1xuICAgICAgICBjb25zdCBraW5nID0gdGhpcy5nZXRLaW5nQnlDb2xvcihjb2xvcik7XG5cbiAgICAgICAgaWYgKCFraW5nIHx8IGtpbmcuaXNNb3ZlZEFscmVhZHkpIHtcbiAgICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBmZW4gPSAnJztcbiAgICAgICAgY29uc3QgbGVmdFJvb2sgPSB0aGlzLmdldFBpZWNlQnlGaWVsZChraW5nLnBvaW50LnJvdywgMCk7XG4gICAgICAgIGNvbnN0IHJpZ2h0Um9vayA9IHRoaXMuZ2V0UGllY2VCeUZpZWxkKGtpbmcucG9pbnQucm93LCA3KTtcblxuICAgICAgICBpZiAocmlnaHRSb29rIGluc3RhbmNlb2YgUm9vayAmJiByaWdodFJvb2suY29sb3IgPT09IGNvbG9yKSB7XG4gICAgICAgICAgICBpZiAoIXJpZ2h0Um9vay5pc01vdmVkQWxyZWFkeSkge1xuICAgICAgICAgICAgICAgIGZlbiArPSB0aGlzLnJldmVydGVkID8gJ3EnIDogJ2snO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGxlZnRSb29rIGluc3RhbmNlb2YgUm9vayAmJiBsZWZ0Um9vay5jb2xvciA9PT0gY29sb3IpIHtcbiAgICAgICAgICAgIGlmICghbGVmdFJvb2suaXNNb3ZlZEFscmVhZHkpIHtcbiAgICAgICAgICAgICAgICBmZW4gKz0gdGhpcy5yZXZlcnRlZCA/ICdrJyA6ICdxJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGZlbiA9IGZlbi5zcGxpdCgnJykuc29ydCgpLmpvaW4oJycpO1xuICAgICAgICByZXR1cm4gY29sb3IgPT09IENvbG9yLkJMQUNLID8gZmVuIDogZmVuLnRvVXBwZXJDYXNlKCk7XG4gICAgfVxuXG4gICAgZ2V0RW5QYXNzYW50RkVOU3RyaW5nKCkge1xuICAgICAgICBpZiAodGhpcy5lblBhc3NhbnRQb2ludCkge1xuICAgICAgICAgICAgaWYgKHRoaXMucmV2ZXJ0ZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgICAgICBTdHJpbmcuZnJvbUNoYXJDb2RlKDEwNCAtIHRoaXMuZW5QYXNzYW50UG9pbnQuY29sKSArXG4gICAgICAgICAgICAgICAgICAgICh0aGlzLmVuUGFzc2FudFBvaW50LnJvdyArIDEpXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZSg5NyArIHRoaXMuZW5QYXNzYW50UG9pbnQuY29sKSArXG4gICAgICAgICAgICAgICAgICAgIChNYXRoLmFicyh0aGlzLmVuUGFzc2FudFBvaW50LnJvdyAtIDcpICsgMSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuICctJztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNhbGN1bGF0ZUZFTigpIHtcbiAgICAgICAgbGV0IGZlbiA9ICcnO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDg7ICsraSkge1xuICAgICAgICAgICAgbGV0IGVtcHR5RmllbGRzID0gMDtcbiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgODsgKytqKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZm91bmRQaWVjZSA9IHRoaXMucGllY2VzLmZpbmQoXG4gICAgICAgICAgICAgICAgICAgIChwaWVjZSkgPT4gcGllY2UucG9pbnQuY29sID09PSBqICYmIHBpZWNlLnBvaW50LnJvdyA9PT0gaSxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIGlmIChmb3VuZFBpZWNlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlbXB0eUZpZWxkcyA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZlbiArPSBlbXB0eUZpZWxkcztcbiAgICAgICAgICAgICAgICAgICAgICAgIGVtcHR5RmllbGRzID0gMDtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChmb3VuZFBpZWNlIGluc3RhbmNlb2YgUm9vaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmVuICs9IGZvdW5kUGllY2UuY29sb3IgPT09IENvbG9yLkJMQUNLID8gJ3InIDogJ1InO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvdW5kUGllY2UgaW5zdGFuY2VvZiBLbmlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZW4gKz0gZm91bmRQaWVjZS5jb2xvciA9PT0gQ29sb3IuQkxBQ0sgPyAnbicgOiAnTic7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3VuZFBpZWNlIGluc3RhbmNlb2YgQmlzaG9wKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlbiArPVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRQaWVjZS5jb2xvciA9PT0gQ29sb3IuQkxBQ0tcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdiJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJ0InO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3VuZFBpZWNlIGluc3RhbmNlb2YgUXVlZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlbiArPVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kUGllY2UuY29sb3IgPT09IENvbG9yLkJMQUNLXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ3EnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJ1EnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvdW5kUGllY2UgaW5zdGFuY2VvZiBLaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVuICs9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kUGllY2UuY29sb3IgPT09IENvbG9yLkJMQUNLXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdrJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnSyc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3VuZFBpZWNlIGluc3RhbmNlb2YgUGF3bikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZW4gKz1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kUGllY2UuY29sb3IgPT09IENvbG9yLkJMQUNLXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAncCdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdQJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm91bmRQaWVjZSBpbnN0YW5jZW9mIENvaW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlbiArPVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kUGllY2UuY29sb3IgPT09XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29sb3IuQkxBQ0tcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAnYydcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnQyc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICArK2VtcHR5RmllbGRzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGVtcHR5RmllbGRzID4gMCkge1xuICAgICAgICAgICAgICAgIGZlbiArPSBlbXB0eUZpZWxkcztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZmVuICs9ICcvJztcbiAgICAgICAgfVxuXG4gICAgICAgIGZlbiA9IGZlbi5zdWJzdHIoMCwgZmVuLmxlbmd0aCAtIDEpO1xuXG4gICAgICAgIGlmICh0aGlzLnJldmVydGVkKSB7XG4gICAgICAgICAgICBmZW4gPSBmZW4uc3BsaXQoJycpLnJldmVyc2UoKS5qb2luKCcnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZlbiArPSAnICcgKyAodGhpcy5jdXJyZW50V2hpdGVQbGF5ZXIgPyAndycgOiAnYicpO1xuICAgICAgICBjb25zdCB3aGl0ZUVuUGFzc2FudCA9IHRoaXMuZ2V0Q2FzdGxlRkVOU3RyaW5nKENvbG9yLldISVRFKTtcbiAgICAgICAgY29uc3QgYmxhY2tFblBhc3NhbnQgPSB0aGlzLmdldENhc3RsZUZFTlN0cmluZyhDb2xvci5CTEFDSyk7XG4gICAgICAgIGxldCBjb25jYXRlZEVuUGFzc2FudCA9IHdoaXRlRW5QYXNzYW50ICsgYmxhY2tFblBhc3NhbnQ7XG4gICAgICAgIGlmICghY29uY2F0ZWRFblBhc3NhbnQpIHtcbiAgICAgICAgICAgIGNvbmNhdGVkRW5QYXNzYW50ID0gJy0nO1xuICAgICAgICB9XG5cbiAgICAgICAgZmVuICs9ICcgJyArIGNvbmNhdGVkRW5QYXNzYW50O1xuICAgICAgICBmZW4gKz0gJyAnICsgdGhpcy5nZXRFblBhc3NhbnRGRU5TdHJpbmcoKTtcbiAgICAgICAgZmVuICs9ICcgJyArIDA7XG4gICAgICAgIGZlbiArPSAnICcgKyB0aGlzLmZ1bGxNb3ZlQ291bnQ7XG4gICAgICAgIHRoaXMuZmVuID0gZmVuO1xuICAgIH1cblxuICAgIGlzWFlJblBvaW50U2VsZWN0aW9uKGk6IG51bWJlciwgajogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJldmVyc2VQb2ludChwb2ludDogUG9pbnQpIHtcbiAgICAgICAgaWYgKHBvaW50KSB7XG4gICAgICAgICAgICBwb2ludC5yb3cgPSBNYXRoLmFicyhwb2ludC5yb3cgLSA3KTtcbiAgICAgICAgICAgIHBvaW50LmNvbCA9IE1hdGguYWJzKHBvaW50LmNvbCAtIDcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldFBpZWNlQnlQb2ludChyb3c6IG51bWJlciwgY29sOiBudW1iZXIpOiBQaWVjZSB7XG4gICAgICAgIHJvdyA9IE1hdGguZmxvb3Iocm93KTtcbiAgICAgICAgY29sID0gTWF0aC5mbG9vcihjb2wpO1xuICAgICAgICByZXR1cm4gdGhpcy5waWVjZXMuZmluZChcbiAgICAgICAgICAgIChwaWVjZSkgPT4gcGllY2UucG9pbnQuY29sID09PSBjb2wgJiYgcGllY2UucG9pbnQucm93ID09PSByb3csXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHVibGljIGNoZWNrSWZQYXduVGFrZXNFblBhc3NhbnQobmV3UG9pbnQ6IFBvaW50KSB7XG4gICAgICAgIGlmIChuZXdQb2ludC5pc0VxdWFsKHRoaXMuZW5QYXNzYW50UG9pbnQpKSB7XG4gICAgICAgICAgICB0aGlzLnBpZWNlcyA9IHRoaXMucGllY2VzLmZpbHRlcihcbiAgICAgICAgICAgICAgICAocGllY2UpID0+IHBpZWNlICE9PSB0aGlzLmVuUGFzc2FudFBpZWNlLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHRoaXMuZW5QYXNzYW50UG9pbnQgPSBudWxsO1xuICAgICAgICAgICAgdGhpcy5lblBhc3NhbnRQaWVjZSA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgY2hlY2tJZlBhd25FbnBhc3NhbnRlZChwaWVjZTogUGF3biwgbmV3UG9pbnQ6IFBvaW50KSB7XG4gICAgICAgIGlmIChNYXRoLmFicyhwaWVjZS5wb2ludC5yb3cgLSBuZXdQb2ludC5yb3cpID4gMSkge1xuICAgICAgICAgICAgdGhpcy5lblBhc3NhbnRQaWVjZSA9IHBpZWNlO1xuICAgICAgICAgICAgdGhpcy5lblBhc3NhbnRQb2ludCA9IG5ldyBQb2ludChcbiAgICAgICAgICAgICAgICAocGllY2UucG9pbnQucm93ICsgbmV3UG9pbnQucm93KSAvIDIsXG4gICAgICAgICAgICAgICAgcGllY2UucG9pbnQuY29sLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZW5QYXNzYW50UG9pbnQgPSBudWxsO1xuICAgICAgICAgICAgdGhpcy5lblBhc3NhbnRQaWVjZSA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpc0tpbmdDaGVja2VkKHBpZWNlOiBQaWVjZSkge1xuICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBLaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gcGllY2UuY29sb3IgPT09IENvbG9yLldISVRFXG4gICAgICAgICAgICAgICAgPyB0aGlzLndoaXRlS2luZ0NoZWNrZWRcbiAgICAgICAgICAgICAgICA6IHRoaXMuYmxhY2tLaW5nQ2hlY2tlZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldEN1cnJlbnRQbGF5ZXJDb2xvcigpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50V2hpdGVQbGF5ZXIgPyBDb2xvci5XSElURSA6IENvbG9yLkJMQUNLO1xuICAgIH1cbn1cbiJdfQ==